<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>vivMorph - AI Image Editor</title>
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?display=swap&family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdn.jsdelivr.net/npm/piexifjs@1.0.6/piexif.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        surface: {
                            0: '#09090b',
                            1: '#111113',
                            2: '#18181b',
                            3: '#1f1f23',
                            4: '#27272a',
                        },
                        accent: {
                            DEFAULT: '#6366f1',
                            light: '#818cf8',
                            dim: '#4f46e5',
                        },
                        neon: {
                            cyan: '#22d3ee',
                            purple: '#a78bfa',
                            pink: '#f472b6',
                            green: '#34d399',
                        }
                    },
                    animation: {
                        'glow': 'glow 2s ease-in-out infinite alternate',
                        'shimmer': 'shimmer 2s linear infinite',
                        'float': 'float 6s ease-in-out infinite',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'slide-up': 'slideUp 0.4s ease-out',
                        'fade-in': 'fadeIn 0.3s ease-out',
                    },
                    keyframes: {
                        glow: {
                            '0%': { boxShadow: '0 0 20px rgba(99, 102, 241, 0.3)' },
                            '100%': { boxShadow: '0 0 40px rgba(99, 102, 241, 0.6), 0 0 80px rgba(99, 102, 241, 0.2)' },
                        },
                        shimmer: {
                            '0%': { backgroundPosition: '-200% 0' },
                            '100%': { backgroundPosition: '200% 0' },
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-8px)' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                    }
                }
            }
        }
    </script>
    <style>
        * { -webkit-tap-highlight-color: transparent; }
        body { background: #09090b; overflow: hidden; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #27272a; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #3f3f46; }

        /* Glass morphism */
        .glass { background: rgba(17, 17, 19, 0.7); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); }
        .glass-heavy { background: rgba(17, 17, 19, 0.85); backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px); }

        /* Gradient borders */
        .border-gradient {
            position: relative;
        }
        .border-gradient::before {
            content: '';
            position: absolute;
            inset: 0;
            padding: 1px;
            border-radius: inherit;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.4), rgba(34, 211, 238, 0.2), rgba(244, 114, 182, 0.3));
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            pointer-events: none;
        }

        /* Drop zone styling */
        .drop-zone { transition: all 0.3s ease; }
        .drop-zone.drag-over { border-color: #6366f1 !important; background: rgba(99, 102, 241, 0.08) !important; }

        /* Image compare slider */
        .compare-slider { cursor: col-resize; }

        /* Model card active state */
        .model-card.active { border-color: rgba(99, 102, 241, 0.6); background: rgba(99, 102, 241, 0.08); }
        .model-card.active .model-dot { background: #6366f1; box-shadow: 0 0 8px rgba(99, 102, 241, 0.6); }

        /* Shimmer effect for loading */
        .shimmer-bg {
            background: linear-gradient(90deg, transparent 0%, rgba(99, 102, 241, 0.1) 50%, transparent 100%);
            background-size: 200% 100%;
        }

        /* Textarea focus glow */
        textarea:focus { box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.25), inset 0 0 20px rgba(99, 102, 241, 0.03); }

        /* Subtle grid background */
        .grid-bg {
            background-image:
                linear-gradient(rgba(99, 102, 241, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(99, 102, 241, 0.03) 1px, transparent 1px);
            background-size: 32px 32px;
        }

        /* Noise texture overlay */
        .noise::after {
            content: '';
            position: fixed;
            inset: 0;
            opacity: 0.015;
            background: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
            pointer-events: none;
            z-index: 9999;
        }

        /* Pulsing dot */
        .pulse-dot {
            width: 6px; height: 6px; border-radius: 50%; background: #34d399;
            animation: pulseDot 2s ease-in-out infinite;
        }
        @keyframes pulseDot {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.5); }
        }

        /* Smooth transitions for panels */
        .panel-transition { transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1); }

        /* Custom range slider */
        input[type="range"] { -webkit-appearance: none; background: transparent; }
        input[type="range"]::-webkit-slider-track { height: 4px; background: #27272a; border-radius: 2px; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; border-radius: 50%; background: #6366f1; margin-top: -6px; cursor: pointer; }

        /* Preset pill hover */
        .preset-pill { transition: all 0.2s ease; }
        .preset-pill:hover { transform: translateY(-1px); }
        .preset-pill:active { transform: translateY(0); }
    </style>
</head>
<body class="font-sans text-white h-screen w-screen overflow-hidden noise grid-bg select-none">

    <!-- ==================== MAIN SINGLE-SCREEN LAYOUT ==================== -->
    <div id="app" class="h-screen w-screen flex flex-col">

        <!-- ===== TOP BAR ===== -->
        <header class="glass-heavy border-b border-white/5 px-4 py-2.5 flex items-center justify-between z-50 shrink-0">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-accent to-neon-cyan flex items-center justify-center">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
                </div>
                <h1 class="text-base font-bold tracking-tight">
                    <span class="bg-gradient-to-r from-white via-white to-zinc-400 bg-clip-text text-transparent">viv</span><span class="bg-gradient-to-r from-accent-light to-neon-cyan bg-clip-text text-transparent">Morph</span>
                </h1>
                <span class="text-[10px] font-mono text-zinc-500 hidden sm:inline">AI IMAGE EDITOR</span>
            </div>

            <!-- Model selector (top bar) -->
            <div class="flex items-center gap-3">
                <div class="flex items-center gap-2">
                    <div class="pulse-dot hidden" id="statusDot"></div>
                    <span class="text-[11px] font-mono text-zinc-500 hidden sm:inline" id="statusText"></span>
                </div>
                <button id="modelSelectorBtn" class="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-surface-3 border border-white/5 hover:border-accent/30 transition-all text-xs font-medium text-zinc-300 hover:text-white">
                    <span id="activeModelName" class="truncate max-w-[120px] sm:max-w-[180px]">Qwen Edit 2511</span>
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                </button>
            </div>
        </header>

        <!-- ===== MAIN CONTENT ===== -->
        <main class="flex-1 flex flex-col lg:flex-row overflow-hidden min-h-0">

            <!-- === LEFT: Canvas Area === -->
            <div class="flex-1 flex flex-col min-h-0 min-w-0">

                <!-- Image Canvas -->
                <div class="flex-1 flex items-center justify-center p-3 sm:p-4 lg:p-6 min-h-0 relative">

                    <!-- Empty State / Drop Zone -->
                    <div id="dropZone" class="drop-zone w-full h-full max-w-3xl max-h-[70vh] mx-auto rounded-2xl border-2 border-dashed border-zinc-700 flex flex-col items-center justify-center gap-4 cursor-pointer hover:border-accent/40 transition-all group">
                        <div class="w-20 h-20 rounded-2xl bg-gradient-to-br from-accent/10 to-neon-cyan/10 border border-accent/20 flex items-center justify-center animate-float">
                            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="text-accent-light">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                <circle cx="9" cy="9" r="2"/>
                                <path d="M21 15l-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/>
                            </svg>
                        </div>
                        <div class="text-center">
                            <p class="text-sm font-semibold text-zinc-300 group-hover:text-white transition-colors">Drop image here or click to upload</p>
                            <p class="text-xs text-zinc-500 mt-1">JPEG, PNG, WebP up to 25MB</p>
                        </div>
                        <button id="uploadBtn" class="mt-2 px-5 py-2 rounded-xl bg-accent hover:bg-accent-light text-white text-sm font-semibold transition-all hover:shadow-lg hover:shadow-accent/20">
                            Choose File
                        </button>
                        <input type="file" id="fileInput" accept="image/*" class="hidden" />
                    </div>

                    <!-- Image Display (hidden until image loaded) -->
                    <div id="imageDisplay" class="hidden w-full h-full max-w-4xl max-h-[75vh] mx-auto relative rounded-2xl overflow-hidden border border-white/5 bg-surface-1">
                        <div id="imageContainer" class="w-full h-full flex items-center justify-center">
                        </div>

                        <!-- Loading overlay -->
                        <div id="loadingOverlay" class="hidden absolute inset-0 bg-surface-0/80 backdrop-blur-sm flex flex-col items-center justify-center z-20">
                            <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-accent/20 to-neon-cyan/20 border border-accent/30 flex items-center justify-center mb-4">
                                <svg class="animate-spin h-7 w-7 text-accent-light" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                            </div>
                            <p id="progressText" class="text-sm font-medium text-zinc-300 mb-3">Transforming...</p>
                            <div class="w-48 h-1.5 bg-surface-4 rounded-full overflow-hidden">
                                <div id="progressBar" class="h-full bg-gradient-to-r from-accent to-neon-cyan rounded-full transition-all duration-500 ease-out" style="width: 0%"></div>
                            </div>
                            <p id="progressPercent" class="text-xs font-mono text-zinc-500 mt-2">0%</p>
                        </div>
                    </div>
                </div>

                <!-- Bottom Image Controls Bar -->
                <div id="imageControls" class="hidden shrink-0 px-4 pb-3 flex items-center justify-between gap-3">
                    <div class="flex items-center gap-2">
                        <!-- Original / Transformed toggle -->
                        <div class="flex rounded-lg bg-surface-2 border border-white/5 p-0.5">
                            <button id="viewOriginalBtn" class="px-3 py-1.5 rounded-md text-xs font-medium transition-all bg-accent/20 text-accent-light border border-accent/30">Original</button>
                            <button id="viewTransformedBtn" class="px-3 py-1.5 rounded-md text-xs font-medium transition-all text-zinc-500 hover:text-zinc-300">Transformed</button>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button id="uploadNewBtn" class="p-2 rounded-lg bg-surface-2 border border-white/5 hover:border-accent/30 transition-all text-zinc-400 hover:text-white" title="Upload new image">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                        </button>
                        <button id="downloadBtn" class="hidden p-2 rounded-lg bg-surface-2 border border-white/5 hover:border-neon-green/30 transition-all text-zinc-400 hover:text-neon-green" title="Download">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        </button>
                        <label class="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-surface-2 border border-white/5 cursor-pointer" title="Use transformed as base for next edit">
                            <span class="text-[11px] text-zinc-500 hidden sm:inline">Iterate</span>
                            <div class="relative">
                                <input type="checkbox" id="editModeToggle" class="sr-only peer">
                                <div class="w-8 h-4 bg-surface-4 rounded-full peer-checked:bg-accent/60 transition-all"></div>
                                <div class="absolute top-0.5 left-0.5 w-3 h-3 bg-zinc-400 rounded-full peer-checked:translate-x-4 peer-checked:bg-white transition-all"></div>
                            </div>
                        </label>
                    </div>
                </div>
            </div>

            <!-- === RIGHT: Control Panel === -->
            <div id="controlPanel" class="lg:w-[380px] xl:w-[420px] shrink-0 border-t lg:border-t-0 lg:border-l border-white/5 flex flex-col bg-surface-1/50 max-h-[40vh] lg:max-h-none overflow-hidden">

                <!-- Prompt Section -->
                <div class="p-4 flex-1 overflow-y-auto min-h-0">

                    <!-- Quick Presets -->
                    <div class="mb-4">
                        <div class="flex items-center justify-between mb-2.5">
                            <h3 class="text-[11px] font-semibold text-zinc-500 uppercase tracking-wider">Quick Styles</h3>
                        </div>
                        <div class="flex flex-wrap gap-1.5">
                            <button class="preset-pill px-2.5 py-1 rounded-full bg-surface-3 border border-white/5 text-[11px] font-medium text-zinc-400 hover:text-white hover:border-green-500/30 hover:bg-green-500/10 transition-all" data-prompt="Transform into Studio Ghibli art style while maintaining the same composition and subjects">Ghibli</button>
                            <button class="preset-pill px-2.5 py-1 rounded-full bg-surface-3 border border-white/5 text-[11px] font-medium text-zinc-400 hover:text-white hover:border-cyan-500/30 hover:bg-cyan-500/10 transition-all" data-prompt="Replace the background with a tropical beach with white sand, clear blue water, and palm trees while maintaining the same facial features, expressions, body positions, and clothing of all people.">Vacation</button>
                            <button class="preset-pill px-2.5 py-1 rounded-full bg-surface-3 border border-white/5 text-[11px] font-medium text-zinc-400 hover:text-white hover:border-yellow-500/30 hover:bg-yellow-500/10 transition-all" data-prompt="Add beer bottles or wine glasses naturally in the hands of each person while maintaining the same facial features, expressions, hair, and body positions.">Drinks</button>
                            <button class="preset-pill px-2.5 py-1 rounded-full bg-surface-3 border border-white/5 text-[11px] font-medium text-zinc-400 hover:text-white hover:border-orange-500/30 hover:bg-orange-500/10 transition-all" data-prompt="Change clothing to authentic ancient Middle Eastern robes, tunics, and sandals while maintaining the same facial features, expressions, hair color, and body positions of each person. Replace background with ancient Jerusalem stone buildings.">Biblical</button>
                            <button class="preset-pill px-2.5 py-1 rounded-full bg-surface-3 border border-white/5 text-[11px] font-medium text-zinc-400 hover:text-white hover:border-pink-500/30 hover:bg-pink-500/10 transition-all" data-prompt="Randomly swap and exchange the faces of all people in the picture with each other, ensuring natural blending and maintaining the same body positions, clothing, and composition exactly as shown.">Face Swap</button>
                            <button class="preset-pill px-2.5 py-1 rounded-full bg-surface-3 border border-white/5 text-[11px] font-medium text-zinc-400 hover:text-white hover:border-purple-500/30 hover:bg-purple-500/10 transition-all" data-prompt="Change clothing to medieval fantasy Westeros-style leather armor, noble house colors, and dark cloaks while maintaining the same facial features, expressions, hair color, and body positions. Replace background with stone castle throne room.">GOT</button>
                            <button class="preset-pill px-2.5 py-1 rounded-full bg-surface-3 border border-white/5 text-[11px] font-medium text-zinc-400 hover:text-white hover:border-amber-500/30 hover:bg-amber-500/10 transition-all" data-prompt="Add well-groomed full beards to each person in the picture while maintaining the same facial features, expressions, eye color, hair color, and body positions.">Beards</button>
                            <button class="preset-pill px-2.5 py-1 rounded-full bg-surface-3 border border-white/5 text-[11px] font-medium text-zinc-400 hover:text-white hover:border-red-500/30 hover:bg-red-500/10 transition-all" data-prompt="Add Donald Trump seamlessly participating in the same activity as the original subjects, maintaining natural lighting and composition while ensuring he blends perfectly with the scene">Trump</button>
                            <button class="preset-pill px-2.5 py-1 rounded-full bg-surface-3 border border-white/5 text-[11px] font-medium text-zinc-400 hover:text-white hover:border-indigo-500/30 hover:bg-indigo-500/10 transition-all" data-prompt="Colorize this image with vibrant, natural colors while preserving all details, textures, and composition exactly as shown.">Colorize</button>
                        </div>
                    </div>

                    <!-- Prompt Input -->
                    <div class="mb-4">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-[11px] font-semibold text-zinc-500 uppercase tracking-wider">Prompt</h3>
                            <button id="optimizeBtn" class="flex items-center gap-1 px-2 py-1 rounded-md bg-amber-500/10 border border-amber-500/20 text-[10px] font-semibold text-amber-400 hover:bg-amber-500/20 hover:text-amber-300 transition-all">
                                <svg width="10" height="10" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L9.19 8.63L2 9.24l5.46 4.73L5.82 21L12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61z"/></svg>
                                AI Optimize
                            </button>
                        </div>
                        <textarea id="promptInput" placeholder="Describe your edit... e.g. 'change the sky to sunset colors'" class="w-full h-24 lg:h-32 resize-none rounded-xl bg-surface-2 border border-white/5 focus:border-accent/40 focus:outline-none text-sm text-zinc-200 placeholder:text-zinc-600 p-3 leading-relaxed transition-all"></textarea>
                    </div>

                    <!-- Aspect Ratio (optional) -->
                    <div class="mb-4">
                        <h3 class="text-[11px] font-semibold text-zinc-500 uppercase tracking-wider mb-2">Aspect Ratio</h3>
                        <div class="flex flex-wrap gap-1.5">
                            <button class="aspect-btn px-2.5 py-1 rounded-lg bg-surface-3 border border-accent/30 text-[11px] font-medium text-accent-light" data-ratio="auto">Auto</button>
                            <button class="aspect-btn px-2.5 py-1 rounded-lg bg-surface-3 border border-white/5 text-[11px] font-medium text-zinc-500 hover:text-zinc-300 hover:border-white/10 transition-all" data-ratio="1:1">1:1</button>
                            <button class="aspect-btn px-2.5 py-1 rounded-lg bg-surface-3 border border-white/5 text-[11px] font-medium text-zinc-500 hover:text-zinc-300 hover:border-white/10 transition-all" data-ratio="3:2">3:2</button>
                            <button class="aspect-btn px-2.5 py-1 rounded-lg bg-surface-3 border border-white/5 text-[11px] font-medium text-zinc-500 hover:text-zinc-300 hover:border-white/10 transition-all" data-ratio="16:9">16:9</button>
                            <button class="aspect-btn px-2.5 py-1 rounded-lg bg-surface-3 border border-white/5 text-[11px] font-medium text-zinc-500 hover:text-zinc-300 hover:border-white/10 transition-all" data-ratio="9:16">9:16</button>
                            <button class="aspect-btn px-2.5 py-1 rounded-lg bg-surface-3 border border-white/5 text-[11px] font-medium text-zinc-500 hover:text-zinc-300 hover:border-white/10 transition-all" data-ratio="4:5">4:5</button>
                        </div>
                    </div>

                    <!-- Model Info Card -->
                    <div id="modelInfoCard" class="rounded-xl bg-surface-2 border border-white/5 p-3 mb-4">
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-[11px] font-semibold text-zinc-400">Active Model</span>
                            <span id="modelPrice" class="text-[10px] font-mono text-neon-green">$0.04</span>
                        </div>
                        <p id="modelNameDisplay" class="text-sm font-semibold text-white mb-1">Qwen Edit 2511</p>
                        <div class="flex items-center gap-2 flex-wrap">
                            <span id="modelPrivacy" class="text-[10px] px-1.5 py-0.5 rounded bg-surface-3 text-zinc-500 font-mono">private</span>
                            <span id="modelMaxPrompt" class="text-[10px] px-1.5 py-0.5 rounded bg-surface-3 text-zinc-500 font-mono">1500 chars</span>
                            <span id="modelCombine" class="text-[10px] px-1.5 py-0.5 rounded bg-surface-3 text-zinc-500 font-mono hidden">combine</span>
                        </div>
                    </div>
                </div>

                <!-- Transform Button (sticky bottom) -->
                <div class="p-4 pt-0 shrink-0">
                    <button id="submitBtn" class="w-full h-11 rounded-xl bg-gradient-to-r from-accent to-accent-dim hover:from-accent-light hover:to-accent text-white text-sm font-bold transition-all hover:shadow-lg hover:shadow-accent/20 disabled:opacity-40 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
                        <span>Transform</span>
                    </button>
                    <p class="text-[10px] text-zinc-600 text-center mt-2">Ctrl+Enter to transform</p>
                </div>
            </div>
        </main>
    </div>

    <!-- ==================== MODEL SELECTOR MODAL ==================== -->
    <div id="modelModal" class="fixed inset-0 z-[100] hidden">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" id="modelModalBackdrop"></div>
        <div class="absolute inset-4 sm:inset-auto sm:top-1/2 sm:left-1/2 sm:-translate-x-1/2 sm:-translate-y-1/2 sm:w-full sm:max-w-lg sm:max-h-[80vh] bg-surface-1 border border-white/5 rounded-2xl overflow-hidden flex flex-col animate-slide-up">
            <div class="p-4 border-b border-white/5 flex items-center justify-between shrink-0">
                <div>
                    <h2 class="text-base font-bold text-white">Select Model</h2>
                    <p class="text-xs text-zinc-500 mt-0.5">Choose an AI model for image editing</p>
                </div>
                <button id="closeModelModal" class="w-8 h-8 rounded-lg bg-surface-3 flex items-center justify-center text-zinc-400 hover:text-white transition-colors">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
            </div>
            <div id="modelList" class="p-4 overflow-y-auto flex-1 space-y-2">
                <!-- Models populated by JS -->
                <div class="text-center py-8">
                    <div class="w-8 h-8 mx-auto mb-3 rounded-full border-2 border-accent/30 border-t-accent animate-spin"></div>
                    <p class="text-xs text-zinc-500">Loading models...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== ERROR MODAL ==================== -->
    <div id="errorModal" class="fixed inset-0 z-[200] hidden">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-sm bg-surface-2 border border-red-500/20 rounded-2xl p-6 animate-slide-up">
            <div class="w-10 h-10 rounded-xl bg-red-500/10 border border-red-500/20 flex items-center justify-center mb-3">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-red-400"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
            </div>
            <h3 class="text-base font-bold text-white mb-2">Error</h3>
            <p id="errorMessage" class="text-sm text-zinc-400 mb-4 leading-relaxed"></p>
            <button id="closeError" class="w-full py-2.5 rounded-xl bg-surface-3 border border-white/5 text-sm font-semibold text-zinc-300 hover:text-white hover:bg-surface-4 transition-all">Dismiss</button>
        </div>
    </div>

    <!-- ==================== JAVASCRIPT ==================== -->
    <script>
    class VivMorph {
        constructor() {
            this.originalImage = null;
            this.originalImageFile = null;
            this.transformedImage = null;
            this.currentView = 'original';
            this.selectedModel = 'qwen-edit';
            this.selectedAspectRatio = 'auto';
            this.models = [];
            this.init();
        }

        init() {
            this.setupEventListeners();
            this.fetchModels();
        }

        // ==================== MODEL MANAGEMENT ====================

        async fetchModels() {
            try {
                const response = await fetch('/.netlify/functions/list-models');
                if (!response.ok) throw new Error('Failed to fetch models');
                const data = await response.json();
                this.models = data.data || [];
                this.renderModelList();
                this.updateModelInfo();
            } catch (error) {
                console.error('Error fetching models:', error);
                // Fallback to hardcoded models
                this.models = [
                    { id: 'qwen-edit', model_spec: { name: 'Qwen Edit 2511', pricing: { inpaint: { usd: 0.04 } }, constraints: { aspectRatios: ['auto','1:1','3:2','16:9','21:9','9:16','2:3','4:5'], promptCharacterLimit: 1500, combineImages: true }, privacy: 'private', traits: [] } },
                    { id: 'flux-2-max-edit', model_spec: { name: 'Flux 2 Max', pricing: { inpaint: { usd: 0.09 } }, constraints: { aspectRatios: ['auto','1:1','3:2','16:9','21:9','9:16','2:3','4:5'], promptCharacterLimit: 3000, combineImages: true }, privacy: 'anonymized', traits: [] } },
                    { id: 'gpt-image-1-5-edit', model_spec: { name: 'GPT Image 1.5', pricing: { inpaint: { usd: 0.23 } }, constraints: { aspectRatios: ['auto','1:1','3:2','2:3'], promptCharacterLimit: 32768, combineImages: true }, privacy: 'anonymized', traits: [] } },
                    { id: 'grok-imagine-edit', model_spec: { name: 'Grok Imagine', pricing: { inpaint: { usd: 0.04 } }, constraints: { aspectRatios: ['auto','1:1','3:2','16:9','21:9','9:16','2:3','4:5'], promptCharacterLimit: 1500, combineImages: false }, privacy: 'anonymized', traits: [] } },
                    { id: 'nano-banana-pro-edit', model_spec: { name: 'Nano Banana Pro', pricing: { inpaint: { usd: 0.18 } }, constraints: { aspectRatios: ['auto','1:1','3:2','16:9','21:9','9:16','2:3','4:5'], promptCharacterLimit: 32768, combineImages: true }, privacy: 'anonymized', traits: [] } },
                    { id: 'seedream-v4-edit', model_spec: { name: 'SeedreamV4.5', pricing: { inpaint: { usd: 0.05 } }, constraints: { aspectRatios: ['auto','1:1','3:2','16:9','9:16','2:3','4:5'], promptCharacterLimit: 10000, combineImages: true }, privacy: 'anonymized', traits: [] } },
                ];
                this.renderModelList();
                this.updateModelInfo();
            }
        }

        renderModelList() {
            const container = document.getElementById('modelList');
            if (!this.models.length) {
                container.innerHTML = '<p class="text-xs text-zinc-500 text-center py-4">No models available</p>';
                return;
            }

            container.innerHTML = this.models.map(model => {
                const spec = model.model_spec;
                const price = spec.pricing?.inpaint?.usd || 0;
                const isActive = model.id === this.selectedModel;
                const isOffline = spec.offline;
                return `
                    <button class="model-card w-full p-3 rounded-xl bg-surface-2 border ${isActive ? 'border-accent/40 bg-accent/5' : 'border-white/5 hover:border-white/10'} text-left transition-all ${isOffline ? 'opacity-40 cursor-not-allowed' : 'cursor-pointer'}" data-model-id="${model.id}" ${isOffline ? 'disabled' : ''}>
                        <div class="flex items-center justify-between mb-1">
                            <div class="flex items-center gap-2">
                                <div class="model-dot w-2 h-2 rounded-full ${isActive ? 'bg-accent shadow-[0_0_8px_rgba(99,102,241,0.6)]' : 'bg-zinc-600'}"></div>
                                <span class="text-sm font-semibold ${isActive ? 'text-white' : 'text-zinc-300'}">${spec.name}</span>
                                ${isOffline ? '<span class="text-[9px] px-1.5 py-0.5 rounded bg-red-500/10 text-red-400 font-mono">offline</span>' : ''}
                            </div>
                            <span class="text-xs font-mono ${price <= 0.05 ? 'text-neon-green' : price <= 0.10 ? 'text-amber-400' : 'text-orange-400'}">$${price.toFixed(2)}</span>
                        </div>
                        <div class="flex items-center gap-1.5 mt-1.5">
                            <span class="text-[9px] px-1.5 py-0.5 rounded bg-surface-3 text-zinc-500 font-mono">${spec.privacy || 'n/a'}</span>
                            <span class="text-[9px] px-1.5 py-0.5 rounded bg-surface-3 text-zinc-500 font-mono">${(spec.constraints?.promptCharacterLimit || 0).toLocaleString()} chars</span>
                            ${spec.constraints?.combineImages ? '<span class="text-[9px] px-1.5 py-0.5 rounded bg-surface-3 text-zinc-500 font-mono">combine</span>' : ''}
                        </div>
                    </button>
                `;
            }).join('');

            // Add click handlers
            container.querySelectorAll('.model-card:not([disabled])').forEach(card => {
                card.addEventListener('click', () => {
                    this.selectedModel = card.dataset.modelId;
                    this.renderModelList();
                    this.updateModelInfo();
                    this.updateAspectRatioButtons();
                    this.closeModelModal();
                });
            });
        }

        updateModelInfo() {
            const model = this.models.find(m => m.id === this.selectedModel);
            if (!model) return;

            const spec = model.model_spec;
            document.getElementById('activeModelName').textContent = spec.name;
            document.getElementById('modelNameDisplay').textContent = spec.name;
            document.getElementById('modelPrice').textContent = '$' + (spec.pricing?.inpaint?.usd || 0).toFixed(2);
            document.getElementById('modelPrivacy').textContent = spec.privacy || 'n/a';
            document.getElementById('modelMaxPrompt').textContent = (spec.constraints?.promptCharacterLimit || 0).toLocaleString() + ' chars';

            const combineEl = document.getElementById('modelCombine');
            if (spec.constraints?.combineImages) {
                combineEl.classList.remove('hidden');
            } else {
                combineEl.classList.add('hidden');
            }

            this.updateAspectRatioButtons();
        }

        updateAspectRatioButtons() {
            const model = this.models.find(m => m.id === this.selectedModel);
            if (!model) return;

            const supportedRatios = model.model_spec.constraints?.aspectRatios || ['auto'];

            document.querySelectorAll('.aspect-btn').forEach(btn => {
                const ratio = btn.dataset.ratio;
                if (supportedRatios.includes(ratio)) {
                    btn.classList.remove('hidden', 'opacity-30', 'pointer-events-none');
                } else {
                    btn.classList.add('opacity-30', 'pointer-events-none');
                }
            });

            // If current selection is not supported, reset to auto
            if (!supportedRatios.includes(this.selectedAspectRatio)) {
                this.selectedAspectRatio = 'auto';
                this.updateAspectRatioUI();
            }
        }

        updateAspectRatioUI() {
            document.querySelectorAll('.aspect-btn').forEach(btn => {
                if (btn.dataset.ratio === this.selectedAspectRatio) {
                    btn.classList.add('border-accent/30', 'text-accent-light');
                    btn.classList.remove('border-white/5', 'text-zinc-500');
                } else {
                    btn.classList.remove('border-accent/30', 'text-accent-light');
                    btn.classList.add('border-white/5', 'text-zinc-500');
                }
            });
        }

        openModelModal() {
            document.getElementById('modelModal').classList.remove('hidden');
        }

        closeModelModal() {
            document.getElementById('modelModal').classList.add('hidden');
        }

        // ==================== EVENT LISTENERS ====================

        setupEventListeners() {
            // File upload
            document.getElementById('uploadBtn').addEventListener('click', (e) => {
                e.stopPropagation();
                document.getElementById('fileInput').click();
            });

            document.getElementById('fileInput').addEventListener('change', (e) => this.handleFileUpload(e));

            // Drop zone
            const dropZone = document.getElementById('dropZone');
            dropZone.addEventListener('click', () => document.getElementById('fileInput').click());
            dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
            dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('drag-over');
                if (e.dataTransfer.files.length) {
                    document.getElementById('fileInput').files = e.dataTransfer.files;
                    this.handleFileUpload({ target: { files: e.dataTransfer.files } });
                }
            });

            // Upload new
            document.getElementById('uploadNewBtn').addEventListener('click', () => {
                document.getElementById('fileInput').click();
            });

            // View toggle
            document.getElementById('viewOriginalBtn').addEventListener('click', () => this.toggleView('original'));
            document.getElementById('viewTransformedBtn').addEventListener('click', () => this.toggleView('transformed'));

            // Presets
            document.querySelectorAll('.preset-pill').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.getElementById('promptInput').value = btn.dataset.prompt;
                });
            });

            // Aspect ratio
            document.querySelectorAll('.aspect-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    if (btn.classList.contains('pointer-events-none')) return;
                    this.selectedAspectRatio = btn.dataset.ratio;
                    this.updateAspectRatioUI();
                });
            });

            // Transform
            document.getElementById('submitBtn').addEventListener('click', () => this.transformImage());

            // Optimize
            document.getElementById('optimizeBtn').addEventListener('click', () => this.optimizePrompt());

            // Download
            document.getElementById('downloadBtn').addEventListener('click', () => this.downloadImage());

            // Model modal
            document.getElementById('modelSelectorBtn').addEventListener('click', () => this.openModelModal());
            document.getElementById('closeModelModal').addEventListener('click', () => this.closeModelModal());
            document.getElementById('modelModalBackdrop').addEventListener('click', () => this.closeModelModal());

            // Error modal
            document.getElementById('closeError').addEventListener('click', () => this.hideErrorModal());

            // Edit mode toggle
            document.getElementById('editModeToggle').addEventListener('change', (e) => this.updateEditMode(e.target.checked));

            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) this.transformImage();
                if (e.key === 'Escape') {
                    this.closeModelModal();
                    this.hideErrorModal();
                }
            });

            // Paste image from clipboard
            document.addEventListener('paste', (e) => {
                const items = e.clipboardData?.items;
                if (!items) return;
                for (const item of items) {
                    if (item.type.startsWith('image/')) {
                        const file = item.getAsFile();
                        if (file) this.handleFileUpload({ target: { files: [file] } });
                        break;
                    }
                }
            });
        }

        // ==================== IMAGE HANDLING ====================

        validateImageFile(file) {
            if (!file.type.startsWith('image/')) {
                this.showError('Please select a valid image file');
                return false;
            }
            if (file.size > 25 * 1024 * 1024) {
                this.showError('Image must be less than 25MB');
                return false;
            }
            return true;
        }

        async handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            if (!this.validateImageFile(file)) return;

            try {
                this.originalImageFile = file;
                const base64 = await this.fileToBase64(file);
                this.originalImage = base64;
                this.transformedImage = null;
                this.currentView = 'original';

                // Show image display, hide drop zone
                document.getElementById('dropZone').classList.add('hidden');
                document.getElementById('imageDisplay').classList.remove('hidden');
                document.getElementById('imageControls').classList.remove('hidden');

                // Reset view toggle
                this.updateViewToggleUI();
                this.displayImage();

                // Hide download button until transform
                document.getElementById('downloadBtn').classList.add('hidden');
            } catch (error) {
                this.showError('Error processing image: ' + error.message);
            }
        }

        displayImage() {
            const container = document.getElementById('imageContainer');
            const imageToShow = this.currentView === 'original' ? this.originalImage : this.transformedImage;

            container.innerHTML = '';

            if (imageToShow) {
                const imageUrl = imageToShow.startsWith('data:') ? imageToShow : `data:image/jpeg;base64,${imageToShow}`;
                const img = document.createElement('img');
                img.src = imageUrl;
                img.alt = this.currentView === 'original' ? 'Original' : 'Transformed';
                img.className = 'max-w-full max-h-full w-auto h-auto object-contain animate-fade-in';
                img.style.maxHeight = '75vh';
                container.appendChild(img);
            } else if (this.currentView === 'transformed') {
                container.innerHTML = '<p class="text-sm text-zinc-600">No transformation yet</p>';
            }
        }

        toggleView(view) {
            this.currentView = view;
            this.updateViewToggleUI();
            this.displayImage();
        }

        updateViewToggleUI() {
            const origBtn = document.getElementById('viewOriginalBtn');
            const transBtn = document.getElementById('viewTransformedBtn');

            if (this.currentView === 'original') {
                origBtn.className = 'px-3 py-1.5 rounded-md text-xs font-medium transition-all bg-accent/20 text-accent-light border border-accent/30';
                transBtn.className = 'px-3 py-1.5 rounded-md text-xs font-medium transition-all text-zinc-500 hover:text-zinc-300';
            } else {
                transBtn.className = 'px-3 py-1.5 rounded-md text-xs font-medium transition-all bg-accent/20 text-accent-light border border-accent/30';
                origBtn.className = 'px-3 py-1.5 rounded-md text-xs font-medium transition-all text-zinc-500 hover:text-zinc-300';
            }
        }

        // ==================== TRANSFORMATION ====================

        async transformImage() {
            const prompt = document.getElementById('promptInput').value.trim();
            if (!prompt) {
                this.showError('Please enter a transformation prompt');
                return;
            }
            if (!this.originalImageFile && !this.originalImage) {
                this.showError('Please upload an image first');
                return;
            }

            // Check prompt length against model limit
            const model = this.models.find(m => m.id === this.selectedModel);
            const charLimit = model?.model_spec?.constraints?.promptCharacterLimit || 32768;
            if (prompt.length > charLimit) {
                this.showError(`Prompt exceeds ${charLimit.toLocaleString()} character limit for ${model?.model_spec?.name || 'this model'}. Please shorten your prompt.`);
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            const loadingOverlay = document.getElementById('loadingOverlay');

            try {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<svg class="animate-spin h-4 w-4" viewBox="0 0 24 24" fill="none"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/></svg><span>Transforming...</span>';
                loadingOverlay.classList.remove('hidden');

                this.simulateProgress();

                // Determine base image
                const editModeToggle = document.getElementById('editModeToggle');
                const useTransformed = editModeToggle.checked && this.transformedImage;
                let imageBase64;

                if (useTransformed) {
                    imageBase64 = this.transformedImage;
                } else if (this.originalImage) {
                    imageBase64 = this.originalImage.startsWith('data:') ? this.originalImage.split(',')[1] : this.originalImage;
                } else {
                    imageBase64 = await this.fileToBase64(this.originalImageFile);
                }

                const requestBody = {
                    prompt: prompt,
                    image: imageBase64,
                    modelId: this.selectedModel,
                };

                if (this.selectedAspectRatio !== 'auto') {
                    requestBody.aspect_ratio = this.selectedAspectRatio;
                }

                const response = await fetch('/.netlify/functions/image-edit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    let errorMessage = `HTTP ${response.status}`;
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.message || errorData.error || errorMessage;
                    } catch (e) {}
                    throw new Error(errorMessage);
                }

                const data = await response.json();
                if (data.image) {
                    this.transformedImage = data.image;
                } else {
                    throw new Error('No image data in response');
                }

                this.completeProgress();
                this.currentView = 'transformed';
                this.updateViewToggleUI();
                this.displayImage();

                // Show download button
                document.getElementById('downloadBtn').classList.remove('hidden');

                // Show status
                this.setStatus('Transform complete', true);

            } catch (error) {
                console.error('Transformation error:', error);
                this.showError('Transform failed: ' + error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg><span>Transform</span>';
                loadingOverlay.classList.add('hidden');
                this.resetProgress();
            }
        }

        simulateProgress() {
            const bar = document.getElementById('progressBar');
            const text = document.getElementById('progressText');
            const pct = document.getElementById('progressPercent');
            if (!bar) return;

            const steps = [
                { p: 15, t: 'Analyzing image...' },
                { p: 35, t: 'Processing prompt...' },
                { p: 55, t: 'Generating transformation...' },
                { p: 75, t: 'Applying edits...' },
                { p: 90, t: 'Refining details...' },
                { p: 96, t: 'Almost done...' },
            ];

            let i = 0;
            const tick = () => {
                if (i < steps.length) {
                    bar.style.width = steps[i].p + '%';
                    text.textContent = steps[i].t;
                    pct.textContent = steps[i].p + '%';
                    i++;
                    setTimeout(tick, 800 + Math.random() * 700);
                }
            };
            tick();
        }

        completeProgress() {
            const bar = document.getElementById('progressBar');
            const text = document.getElementById('progressText');
            const pct = document.getElementById('progressPercent');
            if (bar) bar.style.width = '100%';
            if (text) text.textContent = 'Complete!';
            if (pct) pct.textContent = '100%';
        }

        resetProgress() {
            const bar = document.getElementById('progressBar');
            const text = document.getElementById('progressText');
            const pct = document.getElementById('progressPercent');
            if (bar) bar.style.width = '0%';
            if (text) text.textContent = 'Transforming...';
            if (pct) pct.textContent = '0%';
        }

        // ==================== PROMPT OPTIMIZATION ====================

        async optimizePrompt() {
            const promptInput = document.getElementById('promptInput');
            const userPrompt = promptInput.value.trim();
            if (!userPrompt) {
                this.showError('Please enter a prompt first');
                return;
            }

            const btn = document.getElementById('optimizeBtn');
            const originalHTML = btn.innerHTML;

            try {
                btn.innerHTML = '<svg class="animate-spin h-3 w-3" viewBox="0 0 24 24" fill="none"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/></svg><span>Optimizing...</span>';
                btn.disabled = true;

                const response = await fetch('/.netlify/functions/chat-completions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: 'llama-3.3-70b',
                        messages: [
                            { role: 'system', content: 'You are an expert AI prompt optimizer for image editing. Take the user\'s simple prompt and transform it into a detailed, specific prompt for better image editing results. Focus on clarity, specificity, and preserving subject identity. Return only the optimized prompt, nothing else.' },
                            { role: 'user', content: `Optimize this image editing prompt: "${userPrompt}"` }
                        ],
                        max_tokens: 300,
                        temperature: 0.7
                    })
                });

                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                promptInput.value = data.choices[0].message.content.trim();

                btn.innerHTML = '<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" class="text-neon-green"><polyline points="20 6 9 17 4 12"/></svg><span>Done</span>';
                setTimeout(() => { btn.innerHTML = originalHTML; btn.disabled = false; }, 1500);

            } catch (error) {
                console.error('Optimize error:', error);
                this.showError('Failed to optimize: ' + error.message);
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        }

        // ==================== DOWNLOAD ====================

        downloadImage() {
            const imageToDownload = this.currentView === 'original' ? this.originalImage : this.transformedImage;
            if (!imageToDownload) {
                this.showError('No image to download');
                return;
            }

            try {
                let finalImage = imageToDownload;
                if (this.currentView === 'transformed') {
                    finalImage = this.updateImageMetadata(imageToDownload);
                }

                const link = document.createElement('a');
                link.href = `data:image/jpeg;base64,${finalImage}`;
                link.download = `vivMorph-${this.currentView}-${Date.now()}.jpg`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch (error) {
                this.showError('Download failed: ' + error.message);
            }
        }

        updateImageMetadata(base64Image) {
            try {
                const now = new Date();
                const exifDateTime = [now.getFullYear(), String(now.getMonth()+1).padStart(2,'0'), String(now.getDate()).padStart(2,'0')].join(':') + ' ' + [String(now.getHours()).padStart(2,'0'), String(now.getMinutes()).padStart(2,'0'), String(now.getSeconds()).padStart(2,'0')].join(':');

                const dataURL = 'data:image/jpeg;base64,' + base64Image;
                let exifDict;
                try { exifDict = piexif.load(dataURL); } catch (e) {
                    exifDict = { "0th": {}, "Exif": {}, "GPS": {}, "1st": {}, "thumbnail": null };
                }

                exifDict["0th"][piexif.ImageIFD.DateTime] = exifDateTime;
                exifDict["Exif"][piexif.ExifIFD.DateTimeOriginal] = exifDateTime;
                exifDict["Exif"][piexif.ExifIFD.DateTimeDigitized] = exifDateTime;
                exifDict["0th"][piexif.ImageIFD.Software] = "vivMorph AI Image Editor";

                const exifBytes = piexif.dump(exifDict);
                const newDataURL = piexif.insert(exifBytes, dataURL);
                return newDataURL.split(',')[1];
            } catch (error) {
                return base64Image;
            }
        }

        // ==================== EDIT MODE ====================

        updateEditMode(enabled) {
            if (enabled && this.transformedImage) {
                this.currentView = 'transformed';
                this.updateViewToggleUI();
                this.displayImage();
            }
        }

        // ==================== STATUS ====================

        setStatus(text, show = true) {
            const dot = document.getElementById('statusDot');
            const label = document.getElementById('statusText');
            if (show) {
                dot.classList.remove('hidden');
                label.classList.remove('hidden');
                label.textContent = text;
                setTimeout(() => {
                    dot.classList.add('hidden');
                    label.classList.add('hidden');
                }, 4000);
            }
        }

        // ==================== ERROR HANDLING ====================

        showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorModal').classList.remove('hidden');
        }

        hideErrorModal() {
            document.getElementById('errorModal').classList.add('hidden');
        }

        // ==================== UTILITIES ====================

        fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        base64ToBlob(base64, mimeType) {
            const byteChars = atob(base64);
            const byteNums = new Array(byteChars.length);
            for (let i = 0; i < byteChars.length; i++) byteNums[i] = byteChars.charCodeAt(i);
            return new Blob([new Uint8Array(byteNums)], { type: mimeType });
        }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        window.vivMorph = new VivMorph();
    });
    </script>
</body>
</html>
