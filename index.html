<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>vivMorph - AI Image Editor</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#0a0a0f">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="vivMorph">
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?display=swap&family=Space+Grotesk:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdn.jsdelivr.net/npm/piexifjs@1.0.6/piexif.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Space Grotesk', 'system-ui', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                }
            }
        }
    </script>
    <style>
        :root {
            --c-bg: #06060b;
            --c-surface: #0d0d14;
            --c-surface2: #13131d;
            --c-surface3: #1a1a28;
            --c-border: rgba(255,255,255,0.04);
            --c-glow: #7c5bf5;
            --c-glow2: #00e5a0;
            --c-glow3: #f72585;
            --c-text: #e8e6f0;
            --c-dim: #6b6880;
        }
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        body { background: var(--c-bg); margin: 0; overflow: hidden; }
        ::-webkit-scrollbar { width: 3px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--c-surface3); border-radius: 8px; }

        /* Aurora background */
        .aurora {
            position: fixed; inset: 0; z-index: 0; pointer-events: none; overflow: hidden;
        }
        .aurora-orb {
            position: absolute; border-radius: 50%; filter: blur(120px); opacity: 0.12;
            animation: orbFloat 20s ease-in-out infinite;
        }
        .aurora-orb:nth-child(1) { width: 600px; height: 600px; background: var(--c-glow); top: -20%; left: -10%; animation-delay: 0s; animation-duration: 22s; }
        .aurora-orb:nth-child(2) { width: 500px; height: 500px; background: var(--c-glow2); bottom: -15%; right: -5%; animation-delay: -7s; animation-duration: 18s; }
        .aurora-orb:nth-child(3) { width: 400px; height: 400px; background: var(--c-glow3); top: 40%; left: 50%; animation-delay: -14s; animation-duration: 25s; }
        @keyframes orbFloat {
            0%, 100% { transform: translate(0, 0) scale(1); }
            25% { transform: translate(60px, -40px) scale(1.1); }
            50% { transform: translate(-30px, 50px) scale(0.95); }
            75% { transform: translate(40px, 20px) scale(1.05); }
        }

        /* Noise texture */
        .noise::before {
            content:''; position:fixed; inset:0; opacity:0.025; pointer-events:none; z-index:1;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 512 512' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
        }

        /* Glow border card */
        .glow-card {
            position: relative;
            background: var(--c-surface);
            border: 1px solid var(--c-border);
            border-radius: 16px;
        }
        .glow-card::before {
            content: '';
            position: absolute; inset: -1px;
            border-radius: 17px;
            background: linear-gradient(135deg, rgba(124,91,245,0.15), transparent 40%, transparent 60%, rgba(0,229,160,0.1));
            z-index: -1;
            opacity: 0;
            transition: opacity 0.4s ease;
        }
        .glow-card:hover::before { opacity: 1; }

        /* Animated gradient border for active elements */
        .rainbow-border {
            position: relative;
        }
        .rainbow-border::before {
            content: '';
            position: absolute; inset: -2px;
            border-radius: inherit;
            background: conic-gradient(from var(--angle, 0deg), var(--c-glow), var(--c-glow2), var(--c-glow3), var(--c-glow));
            z-index: -1;
            opacity: 0.6;
            animation: rotateBorder 4s linear infinite;
        }
        @keyframes rotateBorder { to { --angle: 360deg; } }
        @property --angle { syntax: '<angle>'; initial-value: 0deg; inherits: false; }

        /* Glow button */
        .glow-btn {
            position: relative;
            background: linear-gradient(135deg, var(--c-glow), #5b3fe0);
            border: none;
            border-radius: 14px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            overflow: hidden;
        }
        .glow-btn::after {
            content: '';
            position: absolute; inset: 0;
            background: linear-gradient(135deg, transparent, rgba(255,255,255,0.1), transparent);
            transform: translateX(-100%);
            transition: transform 0.5s ease;
        }
        .glow-btn:hover::after { transform: translateX(100%); }
        .glow-btn:hover { box-shadow: 0 0 30px rgba(124,91,245,0.4), 0 0 60px rgba(124,91,245,0.15); transform: translateY(-1px); }
        .glow-btn:active { transform: translateY(0); }
        .glow-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; box-shadow: none; }

        /* Tag pills */
        .tag {
            display: inline-flex; align-items: center; gap: 4px;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 11px; font-weight: 500;
            background: var(--c-surface2);
            border: 1px solid var(--c-border);
            color: var(--c-dim);
            cursor: pointer;
            transition: all 0.25s ease;
            white-space: nowrap;
        }
        .tag:hover { border-color: rgba(124,91,245,0.3); color: var(--c-text); background: rgba(124,91,245,0.06); transform: translateY(-1px); }
        .tag:active { transform: translateY(0); }
        .tag.active { border-color: rgba(124,91,245,0.4); color: #c4b5fd; background: rgba(124,91,245,0.1); }

        /* Drop zone */
        .dropzone {
            border: 2px dashed rgba(124,91,245,0.15);
            border-radius: 24px;
            transition: all 0.35s ease;
            cursor: pointer;
        }
        .dropzone:hover { border-color: rgba(124,91,245,0.35); background: rgba(124,91,245,0.02); }
        .dropzone.drag-over { border-color: var(--c-glow); background: rgba(124,91,245,0.05); }
        .dropzone.drag-over .dz-icon { transform: scale(1.1); }

        .dz-icon {
            width: 80px; height: 80px;
            border-radius: 24px;
            background: linear-gradient(135deg, rgba(124,91,245,0.08), rgba(0,229,160,0.05));
            border: 1px solid rgba(124,91,245,0.12);
            display: flex; align-items: center; justify-content: center;
            transition: transform 0.35s ease;
            animation: breathe 4s ease-in-out infinite;
        }
        @keyframes breathe {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.04); }
        }

        /* Prompt textarea */
        .prompt-area {
            background: var(--c-surface2);
            border: 1px solid var(--c-border);
            border-radius: 14px;
            color: var(--c-text);
            font-size: 13px;
            line-height: 1.6;
            resize: none;
            transition: all 0.3s ease;
            outline: none;
        }
        .prompt-area:focus {
            border-color: rgba(124,91,245,0.3);
            box-shadow: 0 0 0 3px rgba(124,91,245,0.08), 0 0 20px rgba(124,91,245,0.05);
        }
        .prompt-area::placeholder { color: #3d3a50; }

        /* Compare slider */
        .compare-wrap { position:relative; overflow:hidden; cursor:col-resize; touch-action:none; }
        .compare-wrap img { display:block; width:100%; height:100%; object-fit:contain; pointer-events:none; user-select:none; }
        .compare-clip { position:absolute; inset:0; overflow:hidden; }
        .compare-handle {
            position:absolute; top:0; bottom:0; width:2px;
            background: linear-gradient(180deg, var(--c-glow), var(--c-glow2));
            z-index:10; transform:translateX(-50%);
            box-shadow: 0 0 12px rgba(124,91,245,0.4);
        }
        .compare-handle::after {
            content:''; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
            width:32px; height:32px; border-radius:50%;
            background: linear-gradient(135deg, var(--c-glow), var(--c-glow2));
            border:2px solid white;
            box-shadow: 0 0 20px rgba(124,91,245,0.5), inset 0 0 8px rgba(255,255,255,0.2);
        }

        /* Mask canvas */
        .mask-canvas { position:absolute; inset:0; z-index:5; cursor:crosshair; }
        .mask-canvas.eraser { cursor: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24'%3E%3Ccircle cx='12' cy='12' r='10' fill='none' stroke='%23f72585' stroke-width='2'/%3E%3Cline x1='6' y1='12' x2='18' y2='12' stroke='%23f72585' stroke-width='2'/%3E%3C/svg%3E") 12 12, crosshair; }

        /* Status pulse */
        .pulse-dot {
            width: 6px; height: 6px; border-radius: 50%;
            background: var(--c-glow2);
            box-shadow: 0 0 8px rgba(0,229,160,0.6);
            animation: pulse 2s ease-in-out infinite;
        }
        @keyframes pulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:0.5;transform:scale(1.4)} }

        /* Model card */
        .model-card {
            padding: 12px 14px;
            border-radius: 14px;
            background: var(--c-surface2);
            border: 1px solid var(--c-border);
            cursor: pointer;
            transition: all 0.25s ease;
            text-align: left;
            width: 100%;
        }
        .model-card:hover { border-color: rgba(124,91,245,0.2); background: rgba(124,91,245,0.04); }
        .model-card.selected { border-color: rgba(124,91,245,0.4); background: rgba(124,91,245,0.06); }

        /* Slide up animation */
        @keyframes slideUp {
            from { transform: translateY(24px) scale(0.97); opacity: 0; }
            to { transform: translateY(0) scale(1); opacity: 1; }
        }
        .anim-slide-up { animation: slideUp 0.35s cubic-bezier(0.16, 1, 0.3, 1); }

        /* Fade in */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .anim-fade { animation: fadeIn 0.3s ease-out; }

        /* History thumb */
        .history-thumb {
            flex-shrink: 0; width: 44px; height: 44px;
            border-radius: 10px;
            background: var(--c-surface2);
            border: 1px solid var(--c-border);
            overflow: hidden;
            cursor: pointer;
            transition: all 0.25s ease;
            display: flex; align-items: center; justify-content: center;
            position: relative;
        }
        .history-thumb:hover { border-color: rgba(124,91,245,0.3); transform: scale(1.08); }

        /* Spinner */
        .spinner { animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Multi-image thumbnails */
        .multi-thumb {
            position: relative;
            width: 72px; height: 72px;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--c-border);
            background: var(--c-surface2);
            flex-shrink: 0;
            transition: all 0.25s ease;
        }
        .multi-thumb img { width: 100%; height: 100%; object-fit: cover; }
        .multi-thumb:hover { border-color: rgba(124,91,245,0.3); transform: scale(1.05); }
        .multi-thumb .remove-btn {
            position: absolute; top: 2px; right: 2px;
            width: 18px; height: 18px;
            border-radius: 50%;
            background: rgba(248,113,113,0.9);
            border: none;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s ease;
            color: white;
            font-size: 10px; font-weight: bold;
            line-height: 1;
        }
        .multi-thumb:hover .remove-btn { opacity: 1; }

        /* Mode toggle */
        .mode-toggle {
            display: inline-flex;
            border-radius: 10px;
            overflow: hidden;
            background: var(--c-surface);
            border: 1px solid var(--c-border);
        }
        .mode-toggle button {
            padding: 5px 14px;
            font-size: 10px;
            font-weight: 600;
            border: none;
            background: transparent;
            color: var(--c-dim);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .mode-toggle button.active {
            background: rgba(124,91,245,0.12);
            color: #c4b5fd;
        }

        /* Scrollbar for history strip */
        .history-scroll::-webkit-scrollbar { height: 2px; }
        .history-scroll::-webkit-scrollbar-thumb { background: var(--c-surface3); border-radius: 4px; }

        /* Bottom toolbar pills */
        .toolbar-pill {
            display: flex; align-items: center; gap: 4px;
            padding: 5px 10px;
            border-radius: 8px;
            font-size: 10px; font-weight: 600;
            letter-spacing: 0.02em;
            background: var(--c-surface2);
            border: 1px solid var(--c-border);
            color: var(--c-dim);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .toolbar-pill:hover { color: var(--c-text); border-color: rgba(124,91,245,0.2); }
        .toolbar-pill.active { color: #c4b5fd; background: rgba(124,91,245,0.1); border-color: rgba(124,91,245,0.3); }
        .toolbar-pill.active-pink { color: #f472b6; background: rgba(247,37,133,0.08); border-color: rgba(247,37,133,0.25); }

        .icon-btn {
            width: 32px; height: 32px;
            border-radius: 10px;
            background: var(--c-surface2);
            border: 1px solid var(--c-border);
            display: flex; align-items: center; justify-content: center;
            color: var(--c-dim);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .icon-btn:hover { color: var(--c-text); border-color: rgba(124,91,245,0.25); }

        /* Loading bar animation */
        .loading-shimmer {
            background: linear-gradient(90deg, rgba(124,91,245,0.2), rgba(0,229,160,0.3), rgba(124,91,245,0.2));
            background-size: 200% 100%;
            animation: shimmer 1.8s ease-in-out infinite;
        }
        @keyframes shimmer { 0%{background-position:200% 0} 100%{background-position:-200% 0} }

        /* Toggle switch */
        .toggle-track {
            width: 32px; height: 18px;
            border-radius: 999px;
            background: var(--c-surface3);
            position: relative;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        .toggle-track.on { background: rgba(124,91,245,0.5); }
        .toggle-knob {
            position: absolute; top: 2px; left: 2px;
            width: 14px; height: 14px;
            border-radius: 50%;
            background: #6b6880;
            transition: all 0.3s ease;
        }
        .toggle-track.on .toggle-knob { transform: translateX(14px); background: white; box-shadow: 0 0 8px rgba(124,91,245,0.5); }
    </style>
</head>
<body class="font-sans text-[--c-text] h-screen w-screen overflow-hidden noise select-none">
    <!-- Aurora Background -->
    <div class="aurora">
        <div class="aurora-orb"></div>
        <div class="aurora-orb"></div>
        <div class="aurora-orb"></div>
    </div>

    <div id="app" class="h-screen w-screen flex flex-col relative z-10">

        <!-- TOP BAR -->
        <header class="shrink-0 px-4 py-2.5 flex items-center justify-between" style="background: rgba(6,6,11,0.7); backdrop-filter: blur(20px); border-bottom: 1px solid var(--c-border);">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-xl flex items-center justify-center" style="background: linear-gradient(135deg, var(--c-glow), var(--c-glow2)); box-shadow: 0 0 16px rgba(124,91,245,0.3);">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
                </div>
                <div>
                    <h1 class="text-sm font-bold tracking-tight leading-none">
                        <span style="color: #e8e6f0;">viv</span><span style="background: linear-gradient(135deg, #7c5bf5, #00e5a0); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Morph</span>
                    </h1>
                    <p class="text-[9px] font-mono" style="color: var(--c-dim);">AI Image Editor</p>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <div class="pulse-dot hidden" id="statusDot"></div>
                <span class="text-[10px] font-mono hidden sm:inline" style="color: var(--c-dim);" id="statusText"></span>
                <div id="modeToggleWrap" class="mode-toggle">
                    <button id="modeSingleBtn" class="active">Single</button>
                    <button id="modeMultiBtn">Multi</button>
                </div>
                <button id="historyToggleBtn" class="icon-btn hidden" title="History">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                </button>
                <button id="modelSelectorBtn" class="flex items-center gap-1.5 px-3 py-1.5 rounded-xl text-[11px] font-semibold transition-all" style="background: var(--c-surface2); border: 1px solid var(--c-border); color: var(--c-dim);" onmouseover="this.style.borderColor='rgba(124,91,245,0.3)';this.style.color='var(--c-text)'" onmouseout="this.style.borderColor='var(--c-border)';this.style.color='var(--c-dim)'">
                    <span id="activeModelName" class="truncate max-w-[120px] sm:max-w-[180px]">Qwen Edit 2511</span>
                    <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M6 9l6 6 6-6"/></svg>
                </button>
            </div>
        </header>

        <!-- MAIN CONTENT -->
        <main class="flex-1 flex flex-col lg:flex-row overflow-y-auto lg:overflow-hidden min-h-0">
            <!-- LEFT: Canvas Area -->
            <div class="lg:flex-1 flex flex-col min-h-0 min-w-0">
                <div class="flex items-center justify-center p-3 sm:p-4 lg:p-6 min-h-0 relative lg:flex-1">
                    <!-- Drop Zone (Single) -->
                    <div id="dropZone" class="dropzone w-full h-full max-w-3xl max-h-[40vh] lg:max-h-[72vh] mx-auto flex flex-col items-center justify-center gap-4">
                        <div class="dz-icon">
                            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="color: var(--c-glow);">
                                <rect x="3" y="3" width="18" height="18" rx="3"/>
                                <circle cx="9" cy="9" r="2"/>
                                <path d="M21 15l-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/>
                            </svg>
                        </div>
                        <div class="text-center">
                            <p class="text-sm font-semibold" style="color: var(--c-text);">Drop your image here</p>
                            <p class="text-[11px] mt-1" style="color: var(--c-dim);">or click to browse &middot; paste with Ctrl+V</p>
                            <p class="text-[10px] mt-2 font-mono" style="color: #3d3a50;">JPEG, PNG, WebP up to 25MB</p>
                        </div>
                        <button id="uploadBtn" class="glow-btn px-6 py-2 text-xs font-semibold mt-1">Choose File</button>
                        <input type="file" id="fileInput" accept="image/*" class="hidden" />
                    </div>

                    <!-- Drop Zone (Multi) -->
                    <div id="multiDropZone" class="dropzone w-full h-full max-w-3xl max-h-[40vh] lg:max-h-[72vh] mx-auto hidden flex-col items-center justify-center gap-4">
                        <div class="dz-icon">
                            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="color: var(--c-glow2);">
                                <rect x="2" y="2" width="14" height="14" rx="2"/>
                                <rect x="8" y="8" width="14" height="14" rx="2"/>
                            </svg>
                        </div>
                        <div class="text-center">
                            <p class="text-sm font-semibold" style="color: var(--c-text);">Drop multiple images here</p>
                            <p class="text-[11px] mt-1" style="color: var(--c-dim);">or click to browse &middot; combine & edit multiple images</p>
                            <p class="text-[10px] mt-2 font-mono" style="color: #3d3a50;">Up to 5 images &middot; JPEG, PNG, WebP up to 25MB each</p>
                        </div>
                        <!-- Multi-image thumbnails -->
                        <div id="multiThumbs" class="flex gap-2 flex-wrap justify-center max-w-sm"></div>
                        <button id="multiUploadBtn" class="glow-btn px-6 py-2 text-xs font-semibold mt-1" style="background: linear-gradient(135deg, var(--c-glow2), #00b880);">Add Images</button>
                        <input type="file" id="multiFileInput" accept="image/*" multiple class="hidden" />
                    </div>

                    <!-- Image Display -->
                    <div id="imageDisplay" class="hidden w-full h-full max-w-4xl max-h-[40vh] lg:max-h-[75vh] mx-auto relative rounded-2xl overflow-hidden" style="background: var(--c-surface); border: 1px solid var(--c-border);">
                        <div id="imageContainer" class="w-full h-full flex items-center justify-center"></div>
                        <div id="compareContainer" class="hidden compare-wrap w-full h-full">
                            <img id="compareOriginal" class="w-full h-full" alt="Original" />
                            <div id="compareClip" class="compare-clip">
                                <img id="compareTransformed" class="w-full h-full" alt="Transformed" />
                            </div>
                            <div id="compareHandle" class="compare-handle" style="left:50%"></div>
                        </div>
                        <canvas id="maskCanvas" class="mask-canvas hidden"></canvas>
                        <!-- Loading overlay -->
                        <div id="loadingOverlay" class="hidden absolute inset-0 flex flex-col items-center justify-center z-20" style="background: rgba(6,6,11,0.85); backdrop-filter: blur(12px);">
                            <div class="w-16 h-16 rounded-2xl flex items-center justify-center mb-4" style="background: linear-gradient(135deg, rgba(124,91,245,0.12), rgba(0,229,160,0.08)); border: 1px solid rgba(124,91,245,0.15);">
                                <svg class="spinner h-7 w-7" style="color: var(--c-glow);" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-20" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3"/>
                                    <path class="opacity-80" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/>
                                </svg>
                            </div>
                            <p id="progressText" class="text-xs font-medium mb-3" style="color: var(--c-text);">Transforming...</p>
                            <div class="w-48 h-1.5 rounded-full overflow-hidden" style="background: var(--c-surface3);">
                                <div id="progressBar" class="h-full rounded-full transition-all duration-500" style="width:0%; background: linear-gradient(90deg, var(--c-glow), var(--c-glow2));"></div>
                            </div>
                            <p id="progressPercent" class="text-[10px] font-mono mt-2" style="color: var(--c-dim);">0%</p>
                        </div>
                    </div>
                </div>

                <!-- Bottom Toolbar -->
                <div id="imageControls" class="hidden shrink-0 px-4 pb-3 flex items-center justify-between gap-2 flex-wrap">
                    <div class="flex items-center gap-1.5">
                        <div class="flex rounded-lg overflow-hidden" style="background: var(--c-surface); border: 1px solid var(--c-border);">
                            <button id="viewOriginalBtn" class="toolbar-pill active" style="border: none; border-radius: 7px;">Original</button>
                            <button id="viewTransformedBtn" class="toolbar-pill" style="border: none; border-radius: 7px;">Result</button>
                            <button id="viewCompareBtn" class="toolbar-pill" style="border: none; border-radius: 7px;" title="Side-by-side">Compare</button>
                        </div>
                        <!-- Mask tools -->
                        <div id="maskTools" class="hidden flex items-center gap-1 ml-1.5">
                            <button id="maskBrushBtn" class="toolbar-pill active-pink" style="border-radius: 7px;">Brush</button>
                            <button id="maskEraserBtn" class="toolbar-pill" style="border-radius: 7px;">Eraser</button>
                            <button id="maskClearBtn" class="toolbar-pill" style="border-radius: 7px; color: #f87171;">Clear</button>
                            <input id="maskSizeSlider" type="range" min="5" max="80" value="25" class="w-16 h-4 accent-pink-500" title="Brush size" />
                            <span id="maskSizeLabel" class="text-[9px] font-mono w-5" style="color: var(--c-dim);">25</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-1.5">
                        <button id="maskToggleBtn" class="icon-btn" title="Paint mask for selective edits">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 19l7-7 3 3-7 7-3-3z"/><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="M2 2l7.586 7.586"/><circle cx="11" cy="11" r="2"/></svg>
                        </button>
                        <button id="uploadNewBtn" class="icon-btn" title="Upload new image">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                        </button>
                        <button id="downloadBtn" class="hidden icon-btn" title="Download" style="color: var(--c-glow2);">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        </button>
                        <div class="flex items-center gap-1.5 px-2 py-1 rounded-lg cursor-pointer" style="background: var(--c-surface2); border: 1px solid var(--c-border);" title="Iterate on result">
                            <span class="text-[10px] hidden sm:inline" style="color: var(--c-dim);">Iterate</span>
                            <input type="checkbox" id="editModeToggle" class="sr-only peer">
                            <div id="iterateToggle" class="toggle-track" onclick="this.classList.toggle('on'); document.getElementById('editModeToggle').checked = this.classList.contains('on'); window.vivMorph.updateEditMode(this.classList.contains('on'));">
                                <div class="toggle-knob"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- History Strip -->
                <div id="historyStrip" class="hidden shrink-0" style="border-top: 1px solid var(--c-border); background: rgba(6,6,11,0.5);">
                    <div class="flex items-center gap-2.5 px-4 py-2 overflow-x-auto history-scroll">
                        <span class="text-[9px] font-bold uppercase tracking-widest shrink-0" style="color: #3d3a50;">History</span>
                        <div id="historyItems" class="flex gap-1.5 items-center"></div>
                        <button id="clearHistoryBtn" class="shrink-0 text-[9px] px-2 py-0.5 rounded-md transition-colors" style="color: #3d3a50;" onmouseover="this.style.color='#f87171'" onmouseout="this.style.color='#3d3a50'" title="Clear history">Clear</button>
                    </div>
                </div>
            </div>

            <!-- RIGHT: Control Panel -->
            <div class="lg:w-[380px] xl:w-[420px] shrink-0 flex flex-col lg:max-h-none overflow-visible lg:overflow-hidden" style="border-top: 1px solid var(--c-border); border-left: none; background: rgba(10,10,16,0.6); backdrop-filter: blur(16px);" id="controlPanel">
                <div class="p-4 flex-1 overflow-y-auto min-h-0">
                    <!-- Quick Presets -->
                    <div class="mb-5">
                        <h3 class="text-[10px] font-bold uppercase tracking-widest mb-2.5" style="color: #3d3a50;">Quick Styles</h3>
                        <div class="flex flex-wrap gap-1.5">
                            <button class="tag" data-prompt="Transform into Studio Ghibli art style while maintaining the same composition and subjects"><span style="font-size:13px">&#127912;</span> Ghibli</button>
                            <button class="tag" data-prompt="Replace the background with a tropical beach with white sand, clear blue water, and palm trees while maintaining the same facial features, expressions, body positions, and clothing of all people."><span style="font-size:13px">&#127796;</span> Vacation</button>
                            <button class="tag" data-prompt="Add beer bottles or wine glasses naturally in the hands of each person while maintaining the same facial features, expressions, hair, and body positions."><span style="font-size:13px">&#127867;</span> Drinks</button>
                            <button class="tag" data-prompt="Change clothing to authentic ancient Middle Eastern robes, tunics, and sandals while maintaining the same facial features. Replace background with ancient Jerusalem stone buildings."><span style="font-size:13px">&#128220;</span> Biblical</button>
                            <button class="tag" data-prompt="Randomly swap and exchange the faces of all people in the picture with each other, ensuring natural blending and maintaining the same body positions, clothing, and composition."><span style="font-size:13px">&#128260;</span> Face Swap</button>
                            <button class="tag" data-prompt="Change clothing to medieval fantasy Westeros-style leather armor. Replace background with stone castle throne room."><span style="font-size:13px">&#9876;</span> GOT</button>
                            <button class="tag" data-prompt="Add well-groomed full beards to each person while maintaining the same facial features, expressions, eye color, hair color, and body positions."><span style="font-size:13px">&#129492;</span> Beards</button>
                            <button class="tag" data-prompt="Add Donald Trump seamlessly participating in the same activity as the original subjects, maintaining natural lighting and composition."><span style="font-size:13px">&#127482;&#127480;</span> Trump</button>
                            <button class="tag" data-prompt="Colorize this image with vibrant, natural colors while preserving all details, textures, and composition exactly as shown."><span style="font-size:13px">&#127752;</span> Colorize</button>
                            <button class="tag" data-prompt="Seamlessly combine all the uploaded images into a single cohesive scene, maintaining the natural appearance of each person/subject while blending lighting and backgrounds harmoniously." onclick="window.vivMorph?.setMode('multi')"><span style="font-size:13px">&#129520;</span> Merge</button>
                        </div>
                    </div>

                    <!-- Prompt -->
                    <div class="mb-5">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-[10px] font-bold uppercase tracking-widest" style="color: #3d3a50;">Prompt</h3>
                            <button id="optimizeBtn" class="flex items-center gap-1 px-2 py-1 rounded-lg text-[10px] font-semibold transition-all" style="background: rgba(255,183,77,0.06); border: 1px solid rgba(255,183,77,0.15); color: #ffb74d;" onmouseover="this.style.background='rgba(255,183,77,0.12)'" onmouseout="this.style.background='rgba(255,183,77,0.06)'">
                                <svg width="10" height="10" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L9.19 8.63L2 9.24l5.46 4.73L5.82 21L12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61z"/></svg>
                                AI Optimize
                            </button>
                        </div>
                        <textarea id="promptInput" placeholder="Describe how you want to transform the image..." class="prompt-area w-full h-24 lg:h-32 p-3"></textarea>
                    </div>

                    <!-- Transform Button (right after prompt) -->
                    <div class="mb-5">
                        <button id="submitBtn" class="glow-btn w-full h-11 flex items-center justify-center gap-2 text-sm">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
                            <span>Transform</span>
                        </button>
                        <p class="text-[9px] text-center mt-2 font-mono" style="color: #2d2a3a;">Ctrl+Enter to transform</p>
                    </div>

                    <!-- Aspect Ratio -->
                    <div class="mb-5">
                        <h3 class="text-[10px] font-bold uppercase tracking-widest mb-2" style="color: #3d3a50;">Aspect Ratio</h3>
                        <div class="flex flex-wrap gap-1.5">
                            <button class="aspect-btn tag active" data-ratio="auto">Auto</button>
                            <button class="aspect-btn tag" data-ratio="1:1">1:1</button>
                            <button class="aspect-btn tag" data-ratio="3:2">3:2</button>
                            <button class="aspect-btn tag" data-ratio="16:9">16:9</button>
                            <button class="aspect-btn tag" data-ratio="9:16">9:16</button>
                            <button class="aspect-btn tag" data-ratio="4:5">4:5</button>
                        </div>
                    </div>

                    <!-- Model Info Card -->
                    <div class="glow-card p-3.5 mb-4">
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-[10px] font-bold uppercase tracking-widest" style="color: #3d3a50;">Active Model</span>
                            <span id="modelPrice" class="text-[10px] font-mono font-semibold" style="color: var(--c-glow2);">$0.04</span>
                        </div>
                        <p id="modelNameDisplay" class="text-sm font-bold mb-2" style="color: var(--c-text);">Qwen Edit 2511</p>
                        <div class="flex items-center gap-1.5 flex-wrap">
                            <span id="modelPrivacy" class="text-[9px] px-2 py-0.5 rounded-md font-mono" style="background: var(--c-surface3); color: var(--c-dim);">private</span>
                            <span id="modelMaxPrompt" class="text-[9px] px-2 py-0.5 rounded-md font-mono" style="background: var(--c-surface3); color: var(--c-dim);">1,500 chars</span>
                            <span id="modelCombine" class="hidden text-[9px] px-2 py-0.5 rounded-md font-mono" style="background: var(--c-surface3); color: var(--c-dim);">combine</span>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- MODEL MODAL -->
    <div id="modelModal" class="fixed inset-0 z-[100] hidden">
        <div class="absolute inset-0" style="background: rgba(6,6,11,0.7); backdrop-filter: blur(8px);" id="modelModalBackdrop"></div>
        <div class="absolute inset-4 sm:inset-auto sm:top-1/2 sm:left-1/2 sm:-translate-x-1/2 sm:-translate-y-1/2 sm:w-full sm:max-w-lg sm:max-h-[80vh] rounded-2xl overflow-hidden flex flex-col" style="background: var(--c-surface); border: 1px solid var(--c-border);">
            <div class="p-4 flex items-center justify-between shrink-0" style="border-bottom: 1px solid var(--c-border);">
                <div>
                    <h2 class="text-sm font-bold">Select Model</h2>
                    <p class="text-[10px] mt-0.5" style="color: var(--c-dim);">Choose an AI engine for editing</p>
                </div>
                <button id="closeModelModal" class="icon-btn">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
            </div>
            <div id="modelList" class="p-4 overflow-y-auto flex-1 space-y-2">
                <div class="text-center py-8">
                    <div class="w-7 h-7 mx-auto mb-2 rounded-full spinner" style="border: 2px solid var(--c-surface3); border-top-color: var(--c-glow);"></div>
                    <p class="text-[10px]" style="color: var(--c-dim);">Loading models...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- HISTORY MODAL -->
    <div id="historyModal" class="fixed inset-0 z-[100] hidden">
        <div class="absolute inset-0" style="background: rgba(6,6,11,0.7); backdrop-filter: blur(8px);" id="historyModalBackdrop"></div>
        <div class="absolute inset-4 sm:inset-auto sm:top-1/2 sm:left-1/2 sm:-translate-x-1/2 sm:-translate-y-1/2 sm:w-full sm:max-w-md sm:max-h-[70vh] rounded-2xl overflow-hidden flex flex-col" style="background: var(--c-surface); border: 1px solid var(--c-border);">
            <div class="p-4 flex items-center justify-between shrink-0" style="border-bottom: 1px solid var(--c-border);">
                <h2 class="text-sm font-bold">Transform History</h2>
                <button id="closeHistoryModal" class="icon-btn">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
            </div>
            <div id="historyModalItems" class="p-4 overflow-y-auto flex-1 grid grid-cols-2 gap-2.5"></div>
        </div>
    </div>

    <!-- ERROR MODAL -->
    <div id="errorModal" class="fixed inset-0 z-[200] hidden">
        <div class="absolute inset-0" style="background: rgba(6,6,11,0.7); backdrop-filter: blur(8px);"></div>
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-sm p-5 rounded-2xl anim-slide-up" style="background: var(--c-surface); border: 1px solid rgba(248,113,113,0.15);">
            <div class="flex items-center gap-2 mb-2">
                <div class="w-6 h-6 rounded-lg flex items-center justify-center" style="background: rgba(248,113,113,0.1);">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#f87171" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
                </div>
                <h3 class="text-sm font-bold">Something went wrong</h3>
            </div>
            <p id="errorMessage" class="text-xs leading-relaxed mb-4" style="color: var(--c-dim);"></p>
            <button id="closeError" class="w-full py-2.5 rounded-xl text-xs font-semibold transition-all" style="background: var(--c-surface2); border: 1px solid var(--c-border); color: var(--c-dim);" onmouseover="this.style.color='var(--c-text)'" onmouseout="this.style.color='var(--c-dim)'">Dismiss</button>
        </div>
    </div>

    <!-- JAVASCRIPT -->
    <script>
    class VivMorph {
        constructor() {
            this.originalImage = null;
            this.originalImageFile = null;
            this.transformedImage = null;
            this.currentView = 'original';
            this.selectedModel = 'qwen-edit';
            this.selectedAspectRatio = 'auto';
            this.models = [];
            this.history = [];
            this.maxHistory = 20;
            this.maskActive = false;
            this.maskTool = 'brush';
            this.maskBrushSize = 25;
            this.maskDrawing = false;
            this.maskCtx = null;
            this.imageBounds = null;
            this.originalWidth = 0;
            this.originalHeight = 0;
            this.transformedWidth = 0;
            this.transformedHeight = 0;
            this.lastMaskPoint = null;
            // Multi-image mode
            this.multiMode = false;
            this.multiImages = []; // array of { file, base64 }
            this.maxMultiImages = 5;
            this.init();
        }

        init() {
            this.setupEventListeners();
            this.fetchModels();
            this.loadHistory();
            this.registerServiceWorker();
            this.setupResponsivePanel();
        }

        setupResponsivePanel() {
            const panel = document.getElementById('controlPanel');
            if (window.innerWidth >= 1024) {
                panel.style.borderLeft = '1px solid var(--c-border)';
                panel.style.borderTop = 'none';
            }
            window.addEventListener('resize', () => {
                if (window.innerWidth >= 1024) {
                    panel.style.borderLeft = '1px solid var(--c-border)';
                    panel.style.borderTop = 'none';
                } else {
                    panel.style.borderLeft = 'none';
                    panel.style.borderTop = '1px solid var(--c-border)';
                }
            });
        }

        registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js').catch(() => {});
            }
        }

        // ==================== MODELS ====================
        async fetchModels() {
            try {
                const r = await fetch('/.netlify/functions/list-models');
                if (!r.ok) throw new Error();
                const data = await r.json();
                this.models = data.data || [];
            } catch {
                this.models = [
                    { id:'qwen-edit', model_spec:{ name:'Qwen Edit 2511', pricing:{inpaint:{usd:0.04}}, constraints:{aspectRatios:['auto','1:1','3:2','16:9','21:9','9:16','2:3','4:5'], promptCharacterLimit:1500, combineImages:true}, privacy:'private', offline:false }},
                    { id:'flux-2-max-edit', model_spec:{ name:'Flux 2 Max', pricing:{inpaint:{usd:0.09}}, constraints:{aspectRatios:['auto','1:1','3:2','16:9','21:9','9:16','2:3','4:5'], promptCharacterLimit:3000, combineImages:true}, privacy:'anonymized', offline:false }},
                    { id:'gpt-image-1-5-edit', model_spec:{ name:'GPT Image 1.5', pricing:{inpaint:{usd:0.23}}, constraints:{aspectRatios:['auto','1:1','3:2','2:3'], promptCharacterLimit:32768, combineImages:true}, privacy:'anonymized', offline:false }},
                    { id:'grok-imagine-edit', model_spec:{ name:'Grok Imagine', pricing:{inpaint:{usd:0.04}}, constraints:{aspectRatios:['auto','1:1','3:2','16:9','21:9','9:16','2:3','4:5'], promptCharacterLimit:1500, combineImages:false}, privacy:'anonymized', offline:false }},
                    { id:'nano-banana-pro-edit', model_spec:{ name:'Nano Banana Pro', pricing:{inpaint:{usd:0.18}}, constraints:{aspectRatios:['auto','1:1','3:2','16:9','21:9','9:16','2:3','4:5'], promptCharacterLimit:32768, combineImages:true}, privacy:'anonymized', offline:false }},
                    { id:'seedream-v4-edit', model_spec:{ name:'SeedreamV4.5', pricing:{inpaint:{usd:0.05}}, constraints:{aspectRatios:['auto','1:1','3:2','16:9','9:16','2:3','4:5'], promptCharacterLimit:10000, combineImages:true}, privacy:'anonymized', offline:false }},
                ];
            }
            this.renderModelList();
            this.updateModelInfo();
        }

        renderModelList() {
            const c = document.getElementById('modelList');
            if (!this.models.length) { c.innerHTML = '<p class="text-[10px] text-center py-4" style="color:var(--c-dim)">No models found</p>'; return; }
            c.innerHTML = this.models.map(m => {
                const s = m.model_spec, p = s.pricing?.inpaint?.usd||0, active = m.id===this.selectedModel, off = s.offline;
                const priceColor = p <= 0.05 ? 'var(--c-glow2)' : p <= 0.10 ? '#ffb74d' : '#ff7043';
                return `<button class="model-card ${active?'selected':''}" data-model-id="${m.id}" ${off?'disabled style="opacity:0.35;cursor:not-allowed"':''}>
                    <div class="flex items-center justify-between mb-1">
                        <div class="flex items-center gap-2">
                            <div class="w-2 h-2 rounded-full" style="background:${active?'var(--c-glow)':'var(--c-surface3)'}; ${active?'box-shadow:0 0 8px rgba(124,91,245,0.5)':''}"></div>
                            <span class="text-xs font-semibold" style="color:${active?'var(--c-text)':'var(--c-dim)'}">${s.name}</span>
                            ${off?'<span class="text-[8px] px-1.5 rounded font-mono" style="background:rgba(248,113,113,0.08);color:#f87171">offline</span>':''}
                        </div>
                        <span class="text-[10px] font-mono font-semibold" style="color:${priceColor}">$${p.toFixed(2)}</span>
                    </div>
                    <div class="flex items-center gap-1.5 mt-1.5">
                        <span class="text-[8px] px-1.5 py-0.5 rounded font-mono" style="background:var(--c-surface3);color:var(--c-dim)">${s.privacy||'n/a'}</span>
                        <span class="text-[8px] px-1.5 py-0.5 rounded font-mono" style="background:var(--c-surface3);color:var(--c-dim)">${(s.constraints?.promptCharacterLimit||0).toLocaleString()} chars</span>
                        ${s.constraints?.combineImages?'<span class="text-[8px] px-1.5 py-0.5 rounded font-mono" style="background:var(--c-surface3);color:var(--c-dim)">combine</span>':''}
                    </div>
                </button>`;
            }).join('');
            c.querySelectorAll('.model-card:not([disabled])').forEach(card => {
                card.addEventListener('click', () => { this.selectedModel = card.dataset.modelId; this.renderModelList(); this.updateModelInfo(); this.updateAspectRatioButtons(); this.closeModelModal(); });
            });
        }

        updateModelInfo() {
            const m = this.models.find(x => x.id === this.selectedModel); if (!m) return;
            const s = m.model_spec;
            document.getElementById('activeModelName').textContent = s.name;
            document.getElementById('modelNameDisplay').textContent = s.name;
            document.getElementById('modelPrice').textContent = '$' + (s.pricing?.inpaint?.usd||0).toFixed(2);
            document.getElementById('modelPrivacy').textContent = s.privacy||'n/a';
            document.getElementById('modelMaxPrompt').textContent = (s.constraints?.promptCharacterLimit||0).toLocaleString()+' chars';
            const ce = document.getElementById('modelCombine');
            s.constraints?.combineImages ? ce.classList.remove('hidden') : ce.classList.add('hidden');
            this.updateAspectRatioButtons();
        }

        updateAspectRatioButtons() {
            const m = this.models.find(x => x.id === this.selectedModel); if (!m) return;
            const sr = m.model_spec.constraints?.aspectRatios || ['auto'];
            document.querySelectorAll('.aspect-btn').forEach(b => {
                sr.includes(b.dataset.ratio) ? b.classList.remove('opacity-30','pointer-events-none') : b.classList.add('opacity-30','pointer-events-none');
            });
            if (!sr.includes(this.selectedAspectRatio)) { this.selectedAspectRatio = 'auto'; this.updateAspectRatioUI(); }
        }

        updateAspectRatioUI() {
            document.querySelectorAll('.aspect-btn').forEach(b => {
                if (b.dataset.ratio === this.selectedAspectRatio) { b.classList.add('active'); }
                else { b.classList.remove('active'); }
            });
        }

        openModelModal() { document.getElementById('modelModal').classList.remove('hidden'); }
        closeModelModal() { document.getElementById('modelModal').classList.add('hidden'); }

        // ==================== HISTORY ====================
        loadHistory() {
            try {
                const stored = localStorage.getItem('vivmorph_history');
                if (stored) this.history = JSON.parse(stored);
            } catch {}
            this.renderHistory();
        }

        saveHistory() {
            try {
                localStorage.setItem('vivmorph_history', JSON.stringify(this.history.slice(0, this.maxHistory)));
            } catch (e) {
                if (this.history.length > 5) {
                    this.history = this.history.slice(0, 5);
                    try { localStorage.setItem('vivmorph_history', JSON.stringify(this.history)); } catch {}
                }
            }
        }

        addToHistory(prompt, model, imageBase64) {
            this.history.unshift({
                id: Date.now(),
                prompt: prompt.substring(0, 100),
                model,
                fullImage: imageBase64,
                timestamp: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})
            });
            if (this.history.length > this.maxHistory) this.history.pop();
            this.saveHistory();
            this.renderHistory();
        }

        renderHistory() {
            const strip = document.getElementById('historyStrip');
            const items = document.getElementById('historyItems');
            const btn = document.getElementById('historyToggleBtn');
            const modalItems = document.getElementById('historyModalItems');

            if (this.history.length === 0) {
                strip.classList.add('hidden');
                btn.classList.add('hidden');
                return;
            }

            strip.classList.remove('hidden');
            btn.classList.remove('hidden');

            items.innerHTML = this.history.map((h, i) => `
                <button class="history-thumb" data-idx="${i}" title="${h.prompt}">
                    <span class="text-[8px] font-mono" style="color:#3d3a50">#${this.history.length - i}</span>
                    <div class="absolute inset-0 opacity-0 hover:opacity-100 transition-opacity flex items-center justify-center" style="background:rgba(6,6,11,0.7)">
                        <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg>
                    </div>
                </button>
            `).join('');

            items.querySelectorAll('.history-thumb').forEach(el => {
                el.addEventListener('click', () => this.restoreFromHistory(parseInt(el.dataset.idx)));
            });

            modalItems.innerHTML = this.history.map((h, i) => `
                <button class="rounded-xl p-2.5 text-left transition-all" style="background:var(--c-surface2);border:1px solid var(--c-border)" onmouseover="this.style.borderColor='rgba(124,91,245,0.25)'" onmouseout="this.style.borderColor='var(--c-border)'" data-idx="${i}">
                    <div class="w-full h-16 rounded-lg flex items-center justify-center mb-2" style="background: linear-gradient(135deg, rgba(124,91,245,0.04), rgba(0,229,160,0.03));">
                        <span class="text-[10px] font-mono" style="color:#3d3a50">#${this.history.length - i}</span>
                    </div>
                    <p class="text-[9px] truncate" style="color:var(--c-dim)">${h.prompt}</p>
                    <div class="flex items-center justify-between mt-1.5">
                        <span class="text-[8px]" style="color:#3d3a50">${h.model}</span>
                        <span class="text-[8px]" style="color:#3d3a50">${h.timestamp}</span>
                    </div>
                </button>
            `).join('');

            modalItems.querySelectorAll('button').forEach(el => {
                el.addEventListener('click', () => {
                    this.restoreFromHistory(parseInt(el.dataset.idx));
                    document.getElementById('historyModal').classList.add('hidden');
                });
            });
        }

        restoreFromHistory(idx) {
            const entry = this.history[idx];
            if (!entry || !entry.fullImage) return;
            this.transformedImage = entry.fullImage;
            this.currentView = 'transformed';
            this.updateViewToggleUI();
            this.displayImage();
            document.getElementById('downloadBtn').classList.remove('hidden');
            document.getElementById('promptInput').value = entry.prompt;
            this.setStatus('Restored from history');
        }

        clearHistory() {
            this.history = [];
            try { localStorage.removeItem('vivmorph_history'); } catch {}
            this.renderHistory();
        }

        // ==================== COMPARE SLIDER ====================
        initCompareSlider() {
            if (!this.originalImage || !this.transformedImage) return;
            const origSrc = this.originalImage.startsWith('data:') ? this.originalImage : 'data:image/jpeg;base64,' + this.originalImage;
            const transSrc = this.transformedImage.startsWith('data:') ? this.transformedImage : 'data:image/jpeg;base64,' + this.transformedImage;

            const wrap = document.getElementById('compareContainer');
            const newWrap = wrap.cloneNode(false);
            newWrap.innerHTML = wrap.innerHTML;
            wrap.parentNode.replaceChild(newWrap, wrap);
            newWrap.id = 'compareContainer';
            newWrap.className = wrap.className;

            const nOrig = newWrap.querySelector('#compareOriginal');
            const nTrans = newWrap.querySelector('#compareTransformed');
            const nHandle = newWrap.querySelector('#compareHandle');
            const nClip = newWrap.querySelector('#compareClip');
            nOrig.src = origSrc;
            nTrans.src = transSrc;
            nHandle.style.left = '50%';
            nClip.style.clipPath = 'inset(0 0 0 50%)';

            const move = (clientX) => {
                const rect = newWrap.getBoundingClientRect();
                let pct = ((clientX - rect.left) / rect.width) * 100;
                pct = Math.max(0, Math.min(100, pct));
                nHandle.style.left = pct + '%';
                nClip.style.clipPath = `inset(0 0 0 ${pct}%)`;
            };

            let dragging = false;
            newWrap.addEventListener('pointerdown', (e) => { dragging = true; newWrap.setPointerCapture(e.pointerId); move(e.clientX); });
            newWrap.addEventListener('pointermove', (e) => { if (dragging) move(e.clientX); });
            newWrap.addEventListener('pointerup', () => { dragging = false; });
        }

        // ==================== MASK PAINTING ====================
        initMask() {
            const canvas = document.getElementById('maskCanvas');
            const container = document.getElementById('imageDisplay');
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
            this.maskCtx = canvas.getContext('2d', { willReadFrequently: true });
            this.maskCtx.clearRect(0, 0, canvas.width, canvas.height);
            this.lastMaskPoint = null;
            this.updateImageBounds();
        }

        updateImageBounds() {
            const container = document.getElementById('imageDisplay');
            const img = container.querySelector('#imageContainer img');
            if (!img) { this.imageBounds = null; return; }
            const containerRect = container.getBoundingClientRect();
            const imgRect = img.getBoundingClientRect();
            this.imageBounds = {
                left: imgRect.left - containerRect.left,
                top: imgRect.top - containerRect.top,
                width: imgRect.width,
                height: imgRect.height
            };
        }

        toggleMask() {
            this.maskActive = !this.maskActive;
            const canvas = document.getElementById('maskCanvas');
            const tools = document.getElementById('maskTools');
            const btn = document.getElementById('maskToggleBtn');

            if (this.maskActive) {
                canvas.classList.remove('hidden');
                tools.classList.remove('hidden');
                btn.style.color = 'var(--c-glow3)';
                btn.style.borderColor = 'rgba(247,37,133,0.3)';
                this.initMask();
                this.setMaskTool('brush');
            } else {
                canvas.classList.add('hidden');
                tools.classList.add('hidden');
                btn.style.color = 'var(--c-dim)';
                btn.style.borderColor = 'var(--c-border)';
            }
        }

        setMaskTool(tool) {
            this.maskTool = tool;
            const canvas = document.getElementById('maskCanvas');
            const brushBtn = document.getElementById('maskBrushBtn');
            const eraserBtn = document.getElementById('maskEraserBtn');
            if (tool === 'brush') {
                canvas.classList.remove('eraser');
                brushBtn.className = 'toolbar-pill active-pink';
                eraserBtn.className = 'toolbar-pill';
            } else {
                canvas.classList.add('eraser');
                eraserBtn.className = 'toolbar-pill active-pink';
                brushBtn.className = 'toolbar-pill';
            }
        }

        clearMask() {
            if (this.maskCtx) {
                const canvas = document.getElementById('maskCanvas');
                this.maskCtx.clearRect(0, 0, canvas.width, canvas.height);
            }
        }

        maskDraw(x, y) {
            if (!this.maskCtx) return;
            const ctx = this.maskCtx;
            ctx.globalCompositeOperation = this.maskTool === 'eraser' ? 'destination-out' : 'source-over';
            ctx.fillStyle = 'rgba(247, 37, 133, 0.35)';
            const r = this.maskBrushSize / 2;

            // Interpolate between last point and current for smooth strokes
            if (this.lastMaskPoint) {
                const dx = x - this.lastMaskPoint.x;
                const dy = y - this.lastMaskPoint.y;
                const dist = Math.sqrt(dx * dx + dy * dy);
                const steps = Math.max(1, Math.floor(dist / (r * 0.3)));
                for (let i = 0; i <= steps; i++) {
                    const t = i / steps;
                    const px = this.lastMaskPoint.x + dx * t;
                    const py = this.lastMaskPoint.y + dy * t;
                    ctx.beginPath();
                    ctx.arc(px, py, r, 0, Math.PI * 2);
                    ctx.fill();
                }
            } else {
                ctx.beginPath();
                ctx.arc(x, y, r, 0, Math.PI * 2);
                ctx.fill();
            }
            this.lastMaskPoint = { x, y };
        }

        getMaskBase64(targetWidth, targetHeight) {
            const canvas = document.getElementById('maskCanvas');
            if (!canvas || !this.maskActive) return null;
            const tw = targetWidth || this.originalWidth;
            const th = targetHeight || this.originalHeight;
            if (!tw || !th) return null;

            const ctx = canvas.getContext('2d', { willReadFrequently: true });
            const data = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
            let hasContent = false;
            for (let i = 3; i < data.length; i += 4) { if (data[i] > 0) { hasContent = true; break; } }
            if (!hasContent) return null;

            // Get the image bounds within the canvas
            this.updateImageBounds();
            const bounds = this.imageBounds;
            if (!bounds || bounds.width <= 0 || bounds.height <= 0) return null;

            // Extract the mask region that overlaps the displayed image
            const srcX = Math.max(0, Math.floor(bounds.left));
            const srcY = Math.max(0, Math.floor(bounds.top));
            const srcW = Math.min(canvas.width - srcX, Math.ceil(bounds.width));
            const srcH = Math.min(canvas.height - srcY, Math.ceil(bounds.height));
            if (srcW <= 0 || srcH <= 0) return null;

            const srcData = ctx.getImageData(srcX, srcY, srcW, srcH);

            // Create a temporary canvas with the extracted region as black/white
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = srcW;
            tempCanvas.height = srcH;
            const tempCtx = tempCanvas.getContext('2d', { willReadFrequently: true });
            const tempData = tempCtx.createImageData(srcW, srcH);
            for (let i = 0; i < srcData.data.length; i += 4) {
                if (srcData.data[i + 3] > 10) {
                    tempData.data[i] = 255; tempData.data[i+1] = 255; tempData.data[i+2] = 255; tempData.data[i+3] = 255;
                } else {
                    tempData.data[i] = 0; tempData.data[i+1] = 0; tempData.data[i+2] = 0; tempData.data[i+3] = 255;
                }
            }
            tempCtx.putImageData(tempData, 0, 0);

            // Scale to original image dimensions
            const maskCanvas = document.createElement('canvas');
            maskCanvas.width = tw;
            maskCanvas.height = th;
            const maskCtx = maskCanvas.getContext('2d');
            maskCtx.fillStyle = 'black';
            maskCtx.fillRect(0, 0, tw, th);
            maskCtx.imageSmoothingEnabled = false;
            maskCtx.drawImage(tempCanvas, 0, 0, srcW, srcH, 0, 0, tw, th);
            return maskCanvas.toDataURL('image/png').split(',')[1];
        }

        // ==================== EVENTS ====================
        setupEventListeners() {
            document.getElementById('uploadBtn').addEventListener('click', (e) => { e.stopPropagation(); document.getElementById('fileInput').click(); });
            document.getElementById('fileInput').addEventListener('change', (e) => this.handleFileUpload(e));

            const dz = document.getElementById('dropZone');
            dz.addEventListener('click', () => document.getElementById('fileInput').click());
            dz.addEventListener('dragover', (e) => { e.preventDefault(); dz.classList.add('drag-over'); });
            dz.addEventListener('dragleave', () => dz.classList.remove('drag-over'));
            dz.addEventListener('drop', (e) => { e.preventDefault(); dz.classList.remove('drag-over'); if (e.dataTransfer.files.length) { document.getElementById('fileInput').files = e.dataTransfer.files; this.handleFileUpload({target:{files:e.dataTransfer.files}}); } });

            document.getElementById('uploadNewBtn').addEventListener('click', () => document.getElementById('fileInput').click());
            document.getElementById('viewOriginalBtn').addEventListener('click', () => this.toggleView('original'));
            document.getElementById('viewTransformedBtn').addEventListener('click', () => this.toggleView('transformed'));
            document.getElementById('viewCompareBtn').addEventListener('click', () => this.toggleView('compare'));

            document.querySelectorAll('.tag[data-prompt]').forEach(b => { b.addEventListener('click', () => { document.getElementById('promptInput').value = b.dataset.prompt; }); });
            document.querySelectorAll('.aspect-btn').forEach(b => { b.addEventListener('click', () => { if (b.classList.contains('pointer-events-none')) return; this.selectedAspectRatio = b.dataset.ratio; this.updateAspectRatioUI(); }); });

            document.getElementById('submitBtn').addEventListener('click', () => this.transformImage());
            document.getElementById('optimizeBtn').addEventListener('click', () => this.optimizePrompt());
            document.getElementById('downloadBtn').addEventListener('click', () => this.downloadImage());

            document.getElementById('modelSelectorBtn').addEventListener('click', () => this.openModelModal());
            document.getElementById('closeModelModal').addEventListener('click', () => this.closeModelModal());
            document.getElementById('modelModalBackdrop').addEventListener('click', () => this.closeModelModal());

            document.getElementById('historyToggleBtn').addEventListener('click', () => document.getElementById('historyModal').classList.remove('hidden'));
            document.getElementById('closeHistoryModal').addEventListener('click', () => document.getElementById('historyModal').classList.add('hidden'));
            document.getElementById('historyModalBackdrop').addEventListener('click', () => document.getElementById('historyModal').classList.add('hidden'));
            document.getElementById('clearHistoryBtn').addEventListener('click', () => this.clearHistory());

            document.getElementById('closeError').addEventListener('click', () => this.hideErrorModal());

            document.getElementById('maskToggleBtn').addEventListener('click', () => this.toggleMask());
            document.getElementById('maskBrushBtn').addEventListener('click', () => this.setMaskTool('brush'));
            document.getElementById('maskEraserBtn').addEventListener('click', () => this.setMaskTool('eraser'));
            document.getElementById('maskClearBtn').addEventListener('click', () => this.clearMask());
            document.getElementById('maskSizeSlider').addEventListener('input', (e) => {
                this.maskBrushSize = parseInt(e.target.value);
                document.getElementById('maskSizeLabel').textContent = this.maskBrushSize;
            });

            const mc = document.getElementById('maskCanvas');
            mc.addEventListener('pointerdown', (e) => { if (!this.maskActive) return; this.maskDrawing = true; this.lastMaskPoint = null; mc.setPointerCapture(e.pointerId); const r = mc.getBoundingClientRect(); this.maskDraw(e.clientX - r.left, e.clientY - r.top); });
            mc.addEventListener('pointermove', (e) => { if (!this.maskDrawing) return; const r = mc.getBoundingClientRect(); this.maskDraw(e.clientX - r.left, e.clientY - r.top); });
            mc.addEventListener('pointerup', () => { this.maskDrawing = false; this.lastMaskPoint = null; });

            // Multi-image mode listeners
            document.getElementById('modeSingleBtn').addEventListener('click', () => this.setMode('single'));
            document.getElementById('modeMultiBtn').addEventListener('click', () => this.setMode('multi'));
            document.getElementById('multiUploadBtn').addEventListener('click', (e) => { e.stopPropagation(); document.getElementById('multiFileInput').click(); });
            document.getElementById('multiFileInput').addEventListener('change', (e) => this.handleMultiFileUpload(e));

            const mdz = document.getElementById('multiDropZone');
            mdz.addEventListener('click', () => document.getElementById('multiFileInput').click());
            mdz.addEventListener('dragover', (e) => { e.preventDefault(); mdz.classList.add('drag-over'); });
            mdz.addEventListener('dragleave', () => mdz.classList.remove('drag-over'));
            mdz.addEventListener('drop', (e) => { e.preventDefault(); mdz.classList.remove('drag-over'); if (e.dataTransfer.files.length) this.handleMultiFileUpload({target:{files:e.dataTransfer.files}}); });

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) this.transformImage();
                if (e.key === 'Escape') { this.closeModelModal(); this.hideErrorModal(); document.getElementById('historyModal').classList.add('hidden'); }
            });

            document.addEventListener('paste', (e) => {
                const items = e.clipboardData?.items; if (!items) return;
                for (const item of items) {
                    if (item.type.startsWith('image/')) {
                        const f = item.getAsFile();
                        if (f) {
                            if (this.multiMode) this.handleMultiFileUpload({target:{files:[f]}});
                            else this.handleFileUpload({target:{files:[f]}});
                        }
                        break;
                    }
                }
            });

            window.addEventListener('resize', () => { if (this.maskActive) this.initMask(); });
        }

        // ==================== IMAGE HANDLING ====================
        validateImageFile(file) {
            if (!file.type.startsWith('image/')) { this.showError('Please select a valid image file'); return false; }
            if (file.size > 25*1024*1024) { this.showError('Image must be less than 25MB'); return false; }
            return true;
        }

        async handleFileUpload(event) {
            const file = event.target.files[0]; if (!file) return;
            if (!this.validateImageFile(file)) return;
            try {
                this.originalImageFile = file;
                this.originalImage = await this.fileToBase64(file);
                const dims = await this.getImageDimensions(this.originalImage);
                this.originalWidth = dims.width;
                this.originalHeight = dims.height;
                this.transformedImage = null;
                this.transformedWidth = 0;
                this.transformedHeight = 0;
                this.currentView = 'original';
                document.getElementById('dropZone').classList.add('hidden');
                document.getElementById('imageDisplay').classList.remove('hidden');
                document.getElementById('imageControls').classList.remove('hidden');
                this.updateViewToggleUI();
                this.displayImage();
                document.getElementById('downloadBtn').classList.add('hidden');
                if (this.maskActive) this.toggleMask();
            } catch (error) { this.showError('Error processing image: ' + error.message); }
        }

        displayImage() {
            const container = document.getElementById('imageContainer');
            const compareContainer = document.getElementById('compareContainer');

            if (this.currentView === 'compare' && this.originalImage && this.transformedImage) {
                container.classList.add('hidden');
                compareContainer.classList.remove('hidden');
                this.initCompareSlider();
                return;
            }

            container.classList.remove('hidden');
            compareContainer.classList.add('hidden');

            const src = this.currentView === 'original' ? this.originalImage : this.transformedImage;
            container.innerHTML = '';
            if (src) {
                const url = src.startsWith('data:') ? src : 'data:image/jpeg;base64,' + src;
                const img = document.createElement('img');
                img.src = url;
                img.alt = this.currentView;
                img.className = 'max-w-full max-h-full w-auto h-auto object-contain anim-fade';
                container.appendChild(img);
            } else if (this.currentView === 'transformed') {
                container.innerHTML = '<p class="text-xs" style="color:#3d3a50">No transformation yet</p>';
            }
        }

        toggleView(view) {
            if (view === 'compare' && (!this.originalImage || !this.transformedImage)) return;
            this.currentView = view;
            this.updateViewToggleUI();
            this.displayImage();
            if (view === 'compare' && this.maskActive) document.getElementById('maskCanvas').classList.add('hidden');
            else if (this.maskActive) document.getElementById('maskCanvas').classList.remove('hidden');
        }

        updateViewToggleUI() {
            ['viewOriginalBtn','viewTransformedBtn','viewCompareBtn'].forEach(id => {
                const btn = document.getElementById(id);
                const isActive = (id === 'viewOriginalBtn' && this.currentView === 'original') ||
                                 (id === 'viewTransformedBtn' && this.currentView === 'transformed') ||
                                 (id === 'viewCompareBtn' && this.currentView === 'compare');
                if (isActive) btn.classList.add('active');
                else btn.classList.remove('active');
            });
        }

        // ==================== MULTI-IMAGE MODE ====================
        setMode(mode) {
            this.multiMode = mode === 'multi';
            document.getElementById('modeSingleBtn').classList.toggle('active', !this.multiMode);
            document.getElementById('modeMultiBtn').classList.toggle('active', this.multiMode);

            const singleDZ = document.getElementById('dropZone');
            const multiDZ = document.getElementById('multiDropZone');
            const imageDisplay = document.getElementById('imageDisplay');
            const imageControls = document.getElementById('imageControls');

            if (this.multiMode) {
                // Switch to multi mode
                singleDZ.classList.add('hidden');
                imageDisplay.classList.add('hidden');
                imageControls.classList.add('hidden');
                multiDZ.classList.remove('hidden');
                multiDZ.style.display = 'flex';
                if (this.maskActive) this.toggleMask();
            } else {
                // Switch to single mode
                multiDZ.classList.add('hidden');
                multiDZ.style.display = '';
                if (this.originalImage) {
                    imageDisplay.classList.remove('hidden');
                    imageControls.classList.remove('hidden');
                } else {
                    singleDZ.classList.remove('hidden');
                }
            }
        }

        async handleMultiFileUpload(event) {
            const files = Array.from(event.target.files);
            if (!files.length) return;

            for (const file of files) {
                if (this.multiImages.length >= this.maxMultiImages) {
                    this.showError(`Maximum ${this.maxMultiImages} images allowed`);
                    break;
                }
                if (!this.validateImageFile(file)) continue;
                try {
                    const base64 = await this.fileToBase64(file);
                    this.multiImages.push({ file, base64 });
                } catch (e) {
                    this.showError('Error reading file: ' + file.name);
                }
            }
            // Reset input so the same files can be re-selected
            event.target.value = '';
            this.renderMultiThumbs();
        }

        removeMultiImage(index) {
            this.multiImages.splice(index, 1);
            this.renderMultiThumbs();
        }

        renderMultiThumbs() {
            const container = document.getElementById('multiThumbs');
            if (!this.multiImages.length) {
                container.innerHTML = '';
                return;
            }
            container.innerHTML = this.multiImages.map((img, i) => `
                <div class="multi-thumb" data-idx="${i}">
                    <img src="data:image/jpeg;base64,${img.base64}" alt="Image ${i+1}" />
                    <button class="remove-btn" data-idx="${i}" title="Remove">&times;</button>
                    <div class="absolute bottom-0 left-0 right-0 text-center py-0.5" style="background: rgba(0,0,0,0.6);">
                        <span class="text-[8px] font-mono text-white">${i+1}</span>
                    </div>
                </div>
            `).join('');
            container.querySelectorAll('.remove-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.removeMultiImage(parseInt(btn.dataset.idx));
                });
            });
        }

        // ==================== TRANSFORM ====================
        async transformImage() {
            const prompt = document.getElementById('promptInput').value.trim();
            if (!prompt) { this.showError('Please enter a transformation prompt'); return; }

            // Multi-image mode
            if (this.multiMode) {
                return this.transformMultiImages(prompt);
            }

            if (!this.originalImageFile && !this.originalImage) { this.showError('Please upload an image first'); return; }

            const model = this.models.find(m => m.id === this.selectedModel);
            const charLimit = model?.model_spec?.constraints?.promptCharacterLimit || 32768;
            if (prompt.length > charLimit) { this.showError(`Prompt exceeds ${charLimit.toLocaleString()} char limit for ${model?.model_spec?.name}.`); return; }

            const submitBtn = document.getElementById('submitBtn');
            const loadingOverlay = document.getElementById('loadingOverlay');
            try {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<svg class="spinner h-4 w-4" viewBox="0 0 24 24" fill="none"><circle class="opacity-20" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3"/><path class="opacity-80" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/></svg><span>Transforming...</span>';
                loadingOverlay.classList.remove('hidden');
                this.simulateProgress();

                const useTransformed = document.getElementById('editModeToggle').checked && this.transformedImage;
                let imageBase64;
                if (useTransformed) imageBase64 = this.transformedImage;
                else if (this.originalImage) imageBase64 = this.originalImage.startsWith('data:') ? this.originalImage.split(',')[1] : this.originalImage;
                else imageBase64 = await this.fileToBase64(this.originalImageFile);

                const requestBody = { prompt, image: imageBase64, modelId: this.selectedModel };
                if (this.selectedAspectRatio !== 'auto') requestBody.aspect_ratio = this.selectedAspectRatio;
                const maskW = useTransformed ? (this.transformedWidth || this.originalWidth) : this.originalWidth;
                const maskH = useTransformed ? (this.transformedHeight || this.originalHeight) : this.originalHeight;
                const maskData = this.getMaskBase64(maskW, maskH);
                if (maskData) requestBody.mask = maskData;

                const response = await fetch('/.netlify/functions/image-edit', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(requestBody) });
                if (!response.ok) {
                    let msg = `HTTP ${response.status}`;
                    try { const d = await response.json(); msg = d.message || d.error || msg; } catch {}
                    throw new Error(msg);
                }
                const data = await response.json();
                if (data.image) {
                    this.transformedImage = data.image;
                    try {
                        const tDims = await this.getImageDimensions(data.image);
                        this.transformedWidth = tDims.width;
                        this.transformedHeight = tDims.height;
                    } catch {}
                }
                else throw new Error('No image data returned');

                this.completeProgress();
                this.currentView = 'transformed';
                this.updateViewToggleUI();
                this.displayImage();
                document.getElementById('downloadBtn').classList.remove('hidden');
                this.setStatus('Transform complete');
                this.addToHistory(prompt, this.selectedModel, data.image);
            } catch (error) {
                console.error('Transform error:', error);
                this.showError('Transform failed: ' + error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg><span>Transform</span>';
                loadingOverlay.classList.add('hidden');
                this.resetProgress();
            }
        }

        simulateProgress() {
            const bar = document.getElementById('progressBar'), text = document.getElementById('progressText'), pct = document.getElementById('progressPercent');
            if (!bar) return;
            const steps = [{p:15,t:'Analyzing image...'},{p:35,t:'Processing prompt...'},{p:55,t:'Generating...'},{p:75,t:'Applying edits...'},{p:90,t:'Refining...'},{p:96,t:'Almost done...'}];
            let i = 0;
            const tick = () => { if (i < steps.length) { bar.style.width = steps[i].p+'%'; text.textContent = steps[i].t; pct.textContent = steps[i].p+'%'; i++; setTimeout(tick, 800+Math.random()*700); } };
            tick();
        }
        completeProgress() { const b=document.getElementById('progressBar'),t=document.getElementById('progressText'),p=document.getElementById('progressPercent'); if(b)b.style.width='100%'; if(t)t.textContent='Complete!'; if(p)p.textContent='100%'; }
        resetProgress() { const b=document.getElementById('progressBar'),t=document.getElementById('progressText'),p=document.getElementById('progressPercent'); if(b)b.style.width='0%'; if(t)t.textContent='Transforming...'; if(p)p.textContent='0%'; }

        // ==================== MULTI-IMAGE TRANSFORM ====================
        async transformMultiImages(prompt) {
            if (!this.multiImages.length) { this.showError('Please upload at least one image'); return; }
            if (this.multiImages.length < 2) { this.showError('Multi-edit requires at least 2 images. Use Single mode for one image.'); return; }

            const submitBtn = document.getElementById('submitBtn');
            // Show image display area with loading overlay
            const imageDisplay = document.getElementById('imageDisplay');
            const loadingOverlay = document.getElementById('loadingOverlay');
            const multiDZ = document.getElementById('multiDropZone');

            try {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<svg class="spinner h-4 w-4" viewBox="0 0 24 24" fill="none"><circle class="opacity-20" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3"/><path class="opacity-80" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/></svg><span>Multi-Editing...</span>';

                // Show loading in the image display
                imageDisplay.classList.remove('hidden');
                multiDZ.style.display = 'none';
                loadingOverlay.classList.remove('hidden');
                this.simulateProgress();

                const images = this.multiImages.map(img => img.base64);
                const requestBody = { prompt, images, modelId: this.selectedModel };

                const response = await fetch('/.netlify/functions/image-multi-edit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    let msg = `HTTP ${response.status}`;
                    try { const d = await response.json(); msg = d.message || d.error || msg; } catch {}
                    throw new Error(msg);
                }

                const data = await response.json();
                if (data.image) {
                    this.transformedImage = data.image;
                    // Also set as original so single mode can use it
                    this.originalImage = data.image;
                    try {
                        const dims = await this.getImageDimensions(data.image);
                        this.transformedWidth = dims.width;
                        this.transformedHeight = dims.height;
                        this.originalWidth = dims.width;
                        this.originalHeight = dims.height;
                    } catch {}
                } else {
                    throw new Error('No image data returned');
                }

                this.completeProgress();

                // Switch to single mode to view and further edit the result
                this.multiMode = false;
                document.getElementById('modeSingleBtn').classList.add('active');
                document.getElementById('modeMultiBtn').classList.remove('active');
                multiDZ.classList.add('hidden');
                multiDZ.style.display = '';

                this.currentView = 'transformed';
                this.updateViewToggleUI();
                this.displayImage();
                document.getElementById('imageControls').classList.remove('hidden');
                document.getElementById('downloadBtn').classList.remove('hidden');
                this.setStatus('Multi-edit complete');
                this.addToHistory(prompt, this.selectedModel, data.image);
            } catch (error) {
                console.error('Multi-edit error:', error);
                this.showError('Multi-edit failed: ' + error.message);
                // Restore multi drop zone
                imageDisplay.classList.add('hidden');
                multiDZ.style.display = 'flex';
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg><span>Transform</span>';
                loadingOverlay.classList.add('hidden');
                this.resetProgress();
            }
        }

        // ==================== PROMPT OPTIMIZE ====================
        async optimizePrompt() {
            const pi = document.getElementById('promptInput'), up = pi.value.trim();
            if (!up) { this.showError('Enter a prompt first'); return; }
            const btn = document.getElementById('optimizeBtn'), orig = btn.innerHTML;
            try {
                btn.innerHTML = '<svg class="spinner h-3 w-3" viewBox="0 0 24 24" fill="none"><circle class="opacity-20" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3"/><path class="opacity-80" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/></svg>';
                btn.disabled = true;
                const r = await fetch('/.netlify/functions/chat-completions', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ model:'llama-3.3-70b', messages:[{role:'system',content:'You are an expert AI prompt optimizer for image editing. Return only the optimized prompt.'},{role:'user',content:`Optimize this image editing prompt: "${up}"`}], max_tokens:300, temperature:0.7 }) });
                if (!r.ok) throw new Error(`HTTP ${r.status}`);
                const d = await r.json();
                pi.value = d.choices[0].message.content.trim();
                btn.innerHTML = '<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="var(--c-glow2)" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>';
                setTimeout(() => { btn.innerHTML = orig; btn.disabled = false; }, 1500);
            } catch (e) { this.showError('Optimize failed: '+e.message); btn.innerHTML = orig; btn.disabled = false; }
        }

        // ==================== DOWNLOAD ====================
        downloadImage() {
            const img = this.currentView === 'original' ? this.originalImage : this.transformedImage;
            if (!img) { this.showError('No image to download'); return; }
            try {
                let final = img;
                if (this.currentView === 'transformed') final = this.updateImageMetadata(img);
                const link = document.createElement('a');
                link.href = 'data:image/jpeg;base64,' + final;
                link.download = `vivMorph-${this.currentView}-${Date.now()}.jpg`;
                document.body.appendChild(link); link.click(); document.body.removeChild(link);
            } catch (e) { this.showError('Download failed: ' + e.message); }
        }

        updateImageMetadata(b64) {
            try {
                const now = new Date();
                const dt = [now.getFullYear(),String(now.getMonth()+1).padStart(2,'0'),String(now.getDate()).padStart(2,'0')].join(':')+' '+[String(now.getHours()).padStart(2,'0'),String(now.getMinutes()).padStart(2,'0'),String(now.getSeconds()).padStart(2,'0')].join(':');
                const du = 'data:image/jpeg;base64,' + b64;
                let ex; try { ex = piexif.load(du); } catch { ex = {"0th":{},"Exif":{},"GPS":{},"1st":{},thumbnail:null}; }
                ex["0th"][piexif.ImageIFD.DateTime] = dt;
                ex["Exif"][piexif.ExifIFD.DateTimeOriginal] = dt;
                ex["Exif"][piexif.ExifIFD.DateTimeDigitized] = dt;
                ex["0th"][piexif.ImageIFD.Software] = "vivMorph AI Image Editor";
                return piexif.insert(piexif.dump(ex), du).split(',')[1];
            } catch { return b64; }
        }

        // ==================== MISC ====================
        updateEditMode(enabled) { if (enabled && this.transformedImage) { this.currentView = 'transformed'; this.updateViewToggleUI(); this.displayImage(); } }
        setStatus(text) { const d=document.getElementById('statusDot'),l=document.getElementById('statusText'); d.classList.remove('hidden'); l.classList.remove('hidden'); l.textContent=text; setTimeout(()=>{d.classList.add('hidden');l.classList.add('hidden');},4000); }
        showError(msg) { document.getElementById('errorMessage').textContent=msg; document.getElementById('errorModal').classList.remove('hidden'); }
        hideErrorModal() { document.getElementById('errorModal').classList.add('hidden'); }
        fileToBase64(file) { return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result.split(',')[1]); r.onerror=rej; r.readAsDataURL(file); }); }

        getImageDimensions(base64) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => resolve({ width: img.naturalWidth, height: img.naturalHeight });
                img.src = base64.startsWith('data:') ? base64 : 'data:image/jpeg;base64,' + base64;
            });
        }
    }

    document.addEventListener('DOMContentLoaded', () => { window.vivMorph = new VivMorph(); });
    </script>
</body>
</html>
