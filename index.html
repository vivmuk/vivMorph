<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="" />
    <link
      rel="stylesheet"
      as="style"
      onload="this.rel='stylesheet'"
      href="https://fonts.googleapis.com/css2?display=swap&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900&amp;family=Plus+Jakarta+Sans%3Awght%40400%3B500%3B700%3B800"
    />
    <title>vivMorph - AI Image Transformation</title>
    <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64," />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <style>
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    </style>
</head>
<body style='font-family: "Plus Jakarta Sans", "Noto Sans", sans-serif;'>
    
    <!-- Main Upload Screen -->
    <div id="upload-screen" class="relative flex size-full min-h-screen flex-col bg-black justify-between group/design-root overflow-x-hidden">

        
        <!-- Upload Content -->
        <div id="upload-content" class="flex-1">
            <!-- Header -->
            <div class="flex items-center bg-black p-4 pb-2 justify-between lg:px-8">
                <h2 class="text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 via-purple-500 to-pink-500 text-lg lg:text-2xl font-bold leading-tight tracking-[-0.015em] flex-1 text-center pl-12 lg:pl-0 lg:text-left">vivMorph</h2>
                <div class="flex items-center gap-4">
                    <button id="settingsBtn" class="flex cursor-pointer items-center justify-center rounded-xl h-12 w-12 bg-transparent text-white hover:bg-[#333] border border-[#333] hover:border-cyan-400/50 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
                            <path d="M128,80a48,48,0,1,0,48,48A48.05,48.05,0,0,0,128,80Zm0,80a32,32,0,1,1,32-32A32,32,0,0,1,128,160Zm88-29.84q.06-2.16,0-4.32l14.92-18.64a8,8,0,0,0,1.48-7.06,107.21,107.21,0,0,0-10.88-26.25,8,8,0,0,0-6-3.93l-23.72-2.64q-1.48-1.56-3-3L186,40.54a8,8,0,0,0-3.94-6,107.71,107.71,0,0,0-26.25-10.87,8,8,0,0,0-7.06,1.49L130.16,40Q128,40,125.84,40L107.2,25.11a8,8,0,0,0-7.06-1.48A107.6,107.6,0,0,0,73.89,34.51a8,8,0,0,0-3.93,6L67.32,64.27q-1.56,1.49-3,3L40.54,70a8,8,0,0,0-6,3.94,107.71,107.71,0,0,0-10.87,26.25,8,8,0,0,0,1.49,7.06L40,125.84Q40,128,40,130.16L25.11,148.8a8,8,0,0,0-1.48,7.06,107.21,107.21,0,0,0,10.88,26.25,8,8,0,0,0,6,3.93l23.72,2.64q1.49,1.56,3,3L70,215.46a8,8,0,0,0,3.94,6,107.71,107.71,0,0,0,26.25,10.87,8,8,0,0,0,7.06-1.49L125.84,216q2.16.06,4.32,0l18.64,14.92a8,8,0,0,0,7.06,1.48,107.21,107.21,0,0,0,26.25-10.88,8,8,0,0,0,3.93-6l2.64-23.72q1.56-1.48,3-3L215.46,186a8,8,0,0,0,6-3.94,107.71,107.71,0,0,0,10.87-26.25,8,8,0,0,0-1.49-7.06Zm-16.1-6.5a73.93,73.93,0,0,1,0,8.68,8,8,0,0,0,1.74,5.48l14.19,17.73a91.57,91.57,0,0,1-6.23,15L187,173.11a8,8,0,0,0-5.1,2.64,74.11,74.11,0,0,1-6.14,6.14,8,8,0,0,0-2.64,5.1l-2.51,22.58a91.32,91.32,0,0,1-15,6.23l-17.74-14.19a8,8,0,0,0-5-1.75h-.48a73.93,73.93,0,0,1-8.68,0,8,8,0,0,0-5.48,1.74L100.45,215.8a91.57,91.57,0,0,1-15-6.23L82.89,187a8,8,0,0,0-2.64-5.1,74.11,74.11,0,0,1-6.14-6.14,8,8,0,0,0-5.1-2.64L46.43,170.6a91.32,91.32,0,0,1-6.23-15l14.19-17.74a8,8,0,0,0,1.74-5.48,73.93,73.93,0,0,1,0-8.68,8,8,0,0,0-1.74-5.48L40.2,100.45a91.57,91.57,0,0,1,6.23-15L69,82.89a8,8,0,0,0,5.1-2.64,74.11,74.11,0,0,1,6.14-6.14A8,8,0,0,0,82.89,69L85.4,46.43a91.32,91.32,0,0,1,15-6.23l17.74,14.19a8,8,0,0,0,5.48,1.74,73.93,73.93,0,0,1,8.68,0,8,8,0,0,0,5.48-1.74L155.55,40.2a91.57,91.57,0,0,1,15,6.23L173.11,69a8,8,0,0,0,2.64,5.1,74.11,74.11,0,0,1,6.14,6.14,8,8,0,0,0,5.1,2.64l22.58,2.51a91.32,91.32,0,0,1,6.23,15l-14.19,17.74A8,8,0,0,0,199.87,123.66Z"></path>
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- Upload Area -->
            <div class="flex-1 flex items-center justify-center p-4 lg:p-8">
                <div class="text-center max-w-lg mx-auto w-full">
                    <div class="mb-8">
                        <div class="w-24 h-24 lg:w-32 lg:h-32 mx-auto mb-6 bg-gradient-to-br from-cyan-400/20 to-purple-500/20 border border-cyan-400/30 rounded-full flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" class="text-cyan-400" viewBox="0 0 256 256">
                                <path d="M216,40H40A16,16,0,0,0,24,56V200a16,16,0,0,0,16,16H216a16,16,0,0,0,16-16V56A16,16,0,0,0,216,40Zm0,16V158.75l-26.07-26.06a16,16,0,0,0-22.63,0l-20,20-44-44a16,16,0,0,0-22.62,0L40,149.37V56ZM40,172l52-52,80,80H40Zm176,28H194.63l-36-36,20-20L216,181.38V200ZM144,100a12,12,0,1,1,12,12A12,12,0,0,1,144,100Z"></path>
                            </svg>
                        </div>
                        <h3 class="text-white text-xl lg:text-2xl font-bold mb-2">Transform Your Images with AI</h3>
                        <p class="text-gray-300 text-sm lg:text-base mb-6">Upload any image and use natural language to transform it with cutting-edge AI technology</p>
                    </div>
                    
                    <div class="flex justify-center">
                        <input type="file" id="fileInput" accept="image/*" style="display: none;" />
                        <button id="uploadBtn" class="flex min-w-[200px] cursor-pointer items-center justify-center overflow-hidden rounded-xl h-14 px-8 bg-gradient-to-r from-cyan-500 to-purple-500 text-white text-base font-bold leading-normal tracking-[0.015em] hover:from-cyan-400 hover:to-purple-400 transition-all duration-300 shadow-lg hover:shadow-cyan-500/25">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="mr-2" viewBox="0 0 256 256">
                                <path d="M74.34,85.66A8,8,0,0,1,85.66,74.34L120,108.69V24a8,8,0,0,1,16,0v84.69l34.34-34.35a8,8,0,0,1,11.32,11.32l-48,48a8,8,0,0,1-11.32,0ZM240,136v64a16,16,0,0,1-16,16H32a16,16,0,0,1-16-16V136a16,16,0,0,1,16-16H84.4a4,4,0,0,1,2.83,1.17L111,145a24,24,0,0,0,34,0l23.8-23.8A4,4,0,0,1,171.6,120H224A16,16,0,0,1,240,136Zm-40,32a12,12,0,1,0-12,12A12,12,0,0,0,200,168Z"></path>
                            </svg>
                            <span class="truncate">Upload Image</span>
                        </button>
                    </div>
                    
                    <p class="text-gray-400 text-xs lg:text-sm mt-4">Supports JPEG, PNG, WebP up to 10MB</p>
                </div>
            </div>
        </div>
        <!-- Tips Section -->
        <div class="border-t border-[#333] bg-[#111] px-4 py-6 lg:px-8">
            <div class="max-w-4xl mx-auto">
                <h3 class="text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-purple-500 text-lg font-bold mb-4 text-center">
                    🚀 Pro Tips for Better AI Transformations
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                    <div class="bg-[#1a1a1a] border border-[#333] rounded-lg p-4 hover:border-cyan-400/50 transition-colors">
                        <div class="flex items-start gap-3">
                            <span class="text-2xl">🎯</span>
                            <div>
                                <h4 class="text-cyan-400 font-semibold mb-1">Be Specific & Clear</h4>
                                <p class="text-gray-300">Use precise colors, detailed descriptions, and clear action verbs. Avoid vague terms.</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-[#1a1a1a] border border-[#333] rounded-lg p-4 hover:border-purple-400/50 transition-colors">
                        <div class="flex items-start gap-3">
                            <span class="text-2xl">🔒</span>
                            <div>
                                <h4 class="text-purple-400 font-semibold mb-1">Preserve What Matters</h4>
                                <p class="text-gray-300">Use "while maintaining the same [facial features/composition/lighting]" to protect important elements.</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-[#1a1a1a] border border-[#333] rounded-lg p-4 hover:border-pink-400/50 transition-colors">
                        <div class="flex items-start gap-3">
                            <span class="text-2xl">👤</span>
                            <div>
                                <h4 class="text-pink-400 font-semibold mb-1">Name Subjects Directly</h4>
                                <p class="text-gray-300">Use "The woman with short hair" instead of "She" or "It" for better recognition.</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-[#1a1a1a] border border-[#333] rounded-lg p-4 hover:border-yellow-400/50 transition-colors">
                        <div class="flex items-start gap-3">
                            <span class="text-2xl">⚡</span>
                            <div>
                                <h4 class="text-yellow-400 font-semibold mb-1">Use the ✨ Optimize Button</h4>
                                <p class="text-gray-300">Let AI improve your prompts using these best practices automatically!</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
                 </div>
         
         <!-- Bottom Tab Navigation -->
         <div class="bg-black border-t border-[#333] px-4 py-3">
             <div class="flex justify-center">
                 <div class="flex bg-[#1a1a1a] rounded-full p-1">
                     <button id="uploadTab" class="flex items-center justify-center w-12 h-12 rounded-full transition-all duration-300 bg-gradient-to-r from-cyan-500 to-purple-500 text-white">
                         <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 256 256">
                             <path d="M74.34,85.66A8,8,0,0,1,85.66,74.34L120,108.69V24a8,8,0,0,1,16,0v84.69l34.34-34.35a8,8,0,0,1,11.32,11.32l-48,48a8,8,0,0,1-11.32,0ZM240,136v64a16,16,0,0,1-16,16H32a16,16,0,0,1-16-16V136a16,16,0,0,1,16-16H84.4a4,4,0,0,1,2.83,1.17L111,145a24,24,0,0,0,34,0l23.8-23.8A4,4,0,0,1,171.6,120H224A16,16,0,0,1,240,136Zm-40,32a12,12,0,1,0-12,12A12,12,0,0,0,200,168Z"></path>
                         </svg>
                     </button>
                     <button id="savedTab" class="flex items-center justify-center w-12 h-12 rounded-full transition-all duration-300 text-gray-400 hover:text-white hover:bg-gradient-to-r hover:from-cyan-500/20 hover:to-purple-500/20 ml-2">
                         <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 256 256">
                             <path d="M216,40H40A16,16,0,0,0,24,56V200a16,16,0,0,0,16,16H216a16,16,0,0,0,16-16V56A16,16,0,0,0,216,40Zm0,16V158.75l-26.07-26.06a16,16,0,0,0-22.63,0l-20,20-44-44a16,16,0,0,0-22.62,0L40,149.37V56ZM40,172l52-52,80,80H40Zm176,28H194.63l-36-36,20-20L216,181.38V200ZM144,100a12,12,0,1,1,12,12A12,12,0,0,1,144,100Z"></path>
                         </svg>
                     </button>
                 </div>
             </div>
         </div>
         
         <!-- Saved Images Content -->
         <div id="saved-content" class="flex-1 hidden">
            <div class="p-4 lg:p-8">
                <div class="max-w-6xl mx-auto">
                    <div class="text-center mb-8">
                        <h2 class="text-white text-xl lg:text-2xl font-bold mb-2">Your Saved Images</h2>
                        <p class="text-gray-300 text-sm lg:text-base">All your transformed images are saved locally on your device</p>
                    </div>
                    
                    <div id="savedImagesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Saved images will be populated here -->
                    </div>
                    
                    <div id="noSavedImages" class="text-center py-12">
                        <div class="w-16 h-16 mx-auto mb-4 bg-gradient-to-br from-cyan-400/20 to-purple-500/20 border border-cyan-400/30 rounded-full flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" class="text-cyan-400" viewBox="0 0 256 256">
                                <path d="M216,40H40A16,16,0,0,0,24,56V200a16,16,0,0,0,16,16H216a16,16,0,0,0,16-16V56A16,16,0,0,0,216,40Zm0,16V158.75l-26.07-26.06a16,16,0,0,0-22.63,0l-20,20-44-44a16,16,0,0,0-22.62,0L40,149.37V56ZM40,172l52-52,80,80H40Zm176,28H194.63l-36-36,20-20L216,181.38V200ZM144,100a12,12,0,1,1,12,12A12,12,0,0,1,144,100Z"></path>
                            </svg>
                        </div>
                        <h3 class="text-white text-lg font-semibold mb-2">No Saved Images Yet</h3>
                        <p class="text-gray-400 text-sm">Transform some images to see them here!</p>
                    </div>
                    
                    <div class="text-center mt-8 space-y-4">
                        <div class="bg-[#1a1a1a] border border-[#333] rounded-lg p-4 max-w-md mx-auto">
                            <h3 class="text-white text-sm font-semibold mb-2">📊 Storage Management</h3>
                            <div id="storageInfo" class="text-gray-400 text-xs mb-3">
                                <!-- Storage info will be populated here -->
                            </div>
                            <div class="flex gap-2">
                                <button id="clearSavedImages" class="flex-1 px-3 py-2 bg-red-500/20 text-red-400 border border-red-500/30 rounded text-xs hover:bg-red-500/30 transition-colors">
                                    🗑️ Clear All
                                </button>
                                <button id="compressImages" class="flex-1 px-3 py-2 bg-blue-500/20 text-blue-400 border border-blue-500/30 rounded text-xs hover:bg-blue-500/30 transition-colors">
                                    🗜️ Compress
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Screen -->
    <div id="edit-screen" class="relative flex size-full min-h-screen flex-col bg-black justify-between group/design-root overflow-x-hidden lg:flex-row" style="display: none;">
        <!-- Main Content Area -->
        <div class="flex-1 flex flex-col lg:flex-row">
            <!-- Header (Mobile) -->
            <div class="flex items-center bg-black p-4 pb-2 justify-between lg:hidden">
                <div id="backBtn" class="text-white flex size-12 shrink-0 items-center cursor-pointer hover:bg-[#333] rounded-lg transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
                        <path d="M224,128a8,8,0,0,1-8,8H59.31l58.35,58.34a8,8,0,0,1-11.32,11.32l-72-72a8,8,0,0,1,0-11.32l72-72a8,8,0,0,1,11.32,11.32L59.31,120H216A8,8,0,0,1,224,128Z"></path>
                    </svg>
                </div>
                <div class="flex items-center gap-2">
                    <button id="downloadBtn" class="flex cursor-pointer items-center justify-center rounded-lg h-12 w-12 bg-transparent text-white hover:bg-[#333] border border-[#333] hover:border-cyan-400/50 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 256 256">
                            <path d="M74.34,85.66A8,8,0,0,1,85.66,74.34L120,108.69V24a8,8,0,0,1,16,0v84.69l34.34-34.35a8,8,0,0,1,11.32,11.32l-48,48a8,8,0,0,1-11.32,0ZM240,136v64a16,16,0,0,1-16,16H32a16,16,0,0,1-16-16V136a16,16,0,0,1,16-16H84.4a4,4,0,0,1,2.83,1.17L111,145a24,24,0,0,0,34,0l23.8-23.8A4,4,0,0,1,171.6,120H224A16,16,0,0,1,240,136Zm-40,32a12,12,0,1,0-12,12A12,12,0,0,0,200,168Z"></path>
                        </svg>
                    </button>
                    <button id="shareBtn" class="flex cursor-pointer items-center justify-center rounded-lg h-12 w-12 bg-transparent text-white hover:bg-[#333] border border-[#333] hover:border-purple-400/50 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 256 256">
                            <path d="M229.66,109.66l-48,48a8,8,0,0,1-11.32-11.32L204.69,112H165a88,88,0,0,0-85.23,66,8,8,0,0,1-15.5-4A103.94,103.94,0,0,1,165,96h39.71L170.34,61.66a8,8,0,0,1,11.32-11.32l48,48A8,8,0,0,1,229.66,109.66ZM192,208H40V88a8,8,0,0,0-16,0V208a16,16,0,0,0,16,16H192a8,8,0,0,0,0-16Z"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Image Display Area -->
            <div class="flex-1 flex flex-col lg:w-2/3">
                <!-- Desktop Header -->
                <div class="hidden lg:flex items-center bg-black p-6 justify-between border-b border-[#333]">
                    <div class="flex items-center gap-4">
                        <div id="backBtn-desktop" class="text-white flex items-center cursor-pointer hover:bg-[#333] rounded-lg p-2 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 256 256" class="mr-2">
                                <path d="M224,128a8,8,0,0,1-8,8H59.31l58.35,58.34a8,8,0,0,1-11.32,11.32l-72-72a8,8,0,0,1,0-11.32l72-72a8,8,0,0,1,11.32,11.32L59.31,120H216A8,8,0,0,1,224,128Z"></path>
                            </svg>
                            <span class="text-sm font-medium">Back</span>
                        </div>
                        <h2 class="text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-purple-500 text-xl font-bold">vivMorph</h2>
                    </div>
                    <div class="flex items-center gap-2">
                        <button id="downloadBtn-desktop" class="flex cursor-pointer items-center justify-center rounded-lg h-10 px-4 bg-[#333] text-white hover:bg-[#444] border border-[#333] hover:border-cyan-400/50 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 256 256" class="mr-2">
                                <path d="M74.34,85.66A8,8,0,0,1,85.66,74.34L120,108.69V24a8,8,0,0,1,16,0v84.69l34.34-34.35a8,8,0,0,1,11.32,11.32l-48,48a8,8,0,0,1-11.32,0ZM240,136v64a16,16,0,0,1-16,16H32a16,16,0,0,1-16-16V136a16,16,0,0,1,16-16H84.4a4,4,0,0,1,2.83,1.17L111,145a24,24,0,0,0,34,0l23.8-23.8A4,4,0,0,1,171.6,120H224A16,16,0,0,1,240,136Zm-40,32a12,12,0,1,0-12,12A12,12,0,0,0,200,168Z"></path>
                            </svg>
                            <span class="text-sm">Download</span>
                        </button>
                        <button id="shareBtn-desktop" class="flex cursor-pointer items-center justify-center rounded-lg h-10 px-4 bg-[#333] text-white hover:bg-[#444] border border-[#333] hover:border-purple-400/50 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 256 256" class="mr-2">
                                <path d="M229.66,109.66l-48,48a8,8,0,0,1-11.32-11.32L204.69,112H165a88,88,0,0,0-85.23,66,8,8,0,0,1-15.5-4A103.94,103.94,0,0,1,165,96h39.71L170.34,61.66a8,8,0,0,1,11.32-11.32l48,48A8,8,0,0,1,229.66,109.66ZM192,208H40V88a8,8,0,0,0-16,0V208a16,16,0,0,0,16,16H192a8,8,0,0,0,0-16Z"></path>
                            </svg>
                            <span class="text-sm">Share</span>
                        </button>
                    </div>
                </div>

                <!-- Image Container -->
                <div class="flex-1 flex items-center justify-center p-4 lg:p-8">
                    <div class="w-full max-w-4xl aspect-[4/3] lg:aspect-[3/2] rounded-lg flex relative bg-[#1a1a1a] border border-[#333] overflow-hidden">
                        <div id="imageContainer" class="w-full bg-center bg-no-repeat bg-cover aspect-auto rounded-none flex-1 flex items-center justify-center text-white">
                            <div id="loadingSpinner" class="hidden absolute inset-0 flex items-center justify-center bg-black bg-opacity-75 z-10">
                                <div class="text-center">
                                    <svg class="animate-spin h-12 w-12 mx-auto mb-4 text-cyan-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                    <p class="text-white text-sm">Transforming your image...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Image Toggle -->
                <div class="flex px-4 py-3 lg:px-8">
                    <div class="flex h-12 flex-1 max-w-md mx-auto lg:mx-0 items-center justify-center rounded-lg bg-[#1a1a1a] border border-[#333] p-1">
                        <label class="flex cursor-pointer h-full grow items-center justify-center overflow-hidden rounded-lg px-4 has-[:checked]:bg-gradient-to-r has-[:checked]:from-cyan-500/20 has-[:checked]:to-purple-500/20 has-[:checked]:border has-[:checked]:border-cyan-400/50 has-[:checked]:text-white text-gray-400 text-sm font-medium leading-normal transition-colors">
                            <span class="truncate">Original</span>
                            <input type="radio" name="imageToggle" class="invisible w-0" value="original" checked />
                        </label>
                        <label class="flex cursor-pointer h-full grow items-center justify-center overflow-hidden rounded-lg px-4 has-[:checked]:bg-gradient-to-r has-[:checked]:from-cyan-500/20 has-[:checked]:to-purple-500/20 has-[:checked]:border has-[:checked]:border-cyan-400/50 has-[:checked]:text-white text-gray-400 text-sm font-medium leading-normal transition-colors">
                            <span class="truncate">Transformed</span>
                            <input type="radio" name="imageToggle" class="invisible w-0" value="transformed" />
                        </label>
                    </div>
                </div>
            </div>

            <!-- Control Panel -->
            <div class="lg:w-1/3 bg-black lg:border-l border-[#333] flex flex-col">
                <!-- Presets -->
                <div class="p-4 lg:p-6 border-b border-[#333]">
                    <h3 class="text-white text-lg font-semibold mb-4">Quick Styles</h3>
                    <div class="grid grid-cols-2 lg:grid-cols-1 gap-3">
                        <button class="preset-btn flex h-12 items-center justify-start gap-3 rounded-lg bg-[#1a1a1a] border border-[#333] px-4 cursor-pointer hover:bg-[#2a2a2a] hover:border-green-400/50 transition-colors" data-prompt="Transform into Studio Ghibli art style while maintaining the same composition and subjects">
                            <div class="w-8 h-8 rounded bg-gradient-to-br from-green-400 to-blue-500 flex items-center justify-center">
                                <span class="text-white text-xs font-bold">🎨</span>
                            </div>
                            <span class="text-white text-sm font-medium">Studio Ghibli</span>
                        </button>
                        <button class="preset-btn flex h-12 items-center justify-start gap-3 rounded-lg bg-[#1a1a1a] border border-[#333] px-4 cursor-pointer hover:bg-[#2a2a2a] hover:border-red-400/50 transition-colors" data-prompt="Add Donald Trump seamlessly participating in the same activity as the original subjects, maintaining natural lighting and composition while ensuring he blends perfectly with the scene">
                            <div class="w-8 h-8 rounded bg-gradient-to-br from-red-400 to-blue-500 flex items-center justify-center">
                                <span class="text-white text-xs font-bold">🇺🇸</span>
                            </div>
                            <span class="text-white text-sm font-medium">Add Trump</span>
                        </button>

                        <button class="preset-btn flex h-12 items-center justify-start gap-3 rounded-lg bg-[#1a1a1a] border border-[#333] px-4 cursor-pointer hover:bg-[#2a2a2a] hover:border-cyan-400/50 transition-colors" data-prompt="Change the background to a beautiful vacation destination like tropical beach, mountain resort, or exotic island while keeping all subjects and maintaining accurate camera angle, position, and composition">
                            <div class="w-8 h-8 rounded bg-gradient-to-br from-cyan-400 to-purple-500 flex items-center justify-center">
                                <span class="text-white text-xs font-bold">🏖️</span>
                            </div>
                            <span class="text-white text-sm font-medium">Vacation BG</span>
                        </button>
                    </div>
                </div>



                <!-- Prompt Input -->
                <div class="p-4 lg:p-6 flex-1">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-white text-lg font-semibold">Transform Prompt</h3>
                        <button id="optimizeBtn" class="bg-gradient-to-r from-yellow-400 to-orange-500 text-black px-4 py-2 rounded-lg text-sm font-bold hover:from-yellow-300 hover:to-orange-400 transition-all duration-300 shadow-lg hover:shadow-yellow-400/25 border-2 border-yellow-400/50 hover:border-yellow-400">
                            ✨ AI Optimize
                        </button>
                    </div>
                    <div class="space-y-4">
                        <textarea id="promptInput" placeholder="Describe how you want to transform your image..." class="w-full h-32 lg:h-40 resize-none rounded-lg text-white bg-[#1a1a1a] border border-[#333] focus:outline-none focus:ring-2 focus:ring-cyan-400/50 focus:border-cyan-400/50 placeholder:text-gray-400 p-4 text-sm leading-relaxed"></textarea>
                        
                        <div class="flex gap-3">
                            <button id="submitBtn" class="flex-1 cursor-pointer items-center justify-center overflow-hidden rounded-lg h-12 px-4 bg-gradient-to-r from-cyan-500 to-purple-500 text-white text-sm font-bold leading-normal tracking-[0.015em] hover:from-cyan-400 hover:to-purple-400 transition-all duration-300 shadow-lg hover:shadow-cyan-500/25 disabled:opacity-50 disabled:cursor-not-allowed flex">
                                <span class="truncate">Transform Image</span>
                            </button>
                        </div>
                        <div id="iterationIndicator" class="text-xs text-gray-400 text-center py-2 hidden">
                            <span class="bg-purple-500/20 text-purple-400 px-2 py-1 rounded-full border border-purple-500/30">
                                🔄 Transforming from current result
                            </span>
                        </div>
                        
                        <div class="bg-[#1a1a1a] border border-[#333] rounded-lg p-4">
                            <p class="text-gray-300 text-xs leading-relaxed mb-2">
                                <span class="text-cyan-400 font-semibold">💡 Pro Tip:</span> For best results, be specific about what to change while mentioning what should stay the same.
                            </p>
                            <p class="text-gray-400 text-xs leading-relaxed">
                                Try: "Transform into [style] while maintaining the same [subjects/composition]"
                            </p>
                        </div>
                        
                        <!-- Transform Options -->
                        <div class="mt-6 pt-4 border-t border-[#333]">
                            <h4 class="text-white text-sm font-semibold mb-3">Transform Options</h4>
                            <div class="space-y-3">
                                <div class="flex items-center justify-between p-3 bg-[#1a1a1a] border border-[#333] rounded-lg">
                                    <div class="flex items-center gap-3">
                                        <div class="w-8 h-8 bg-gradient-to-br from-cyan-400/20 to-purple-500/20 border border-cyan-400/30 rounded-full flex items-center justify-center">
                                            <span class="text-cyan-400 text-xs">🔄</span>
                                        </div>
                                        <div>
                                            <h5 class="text-white text-sm font-medium">Use Transformed Image</h5>
                                            <p class="text-gray-400 text-xs">ON = Use transformed as seed, OFF = Use original</p>
                                        </div>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="editModeToggle" class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-gradient-to-r peer-checked:from-cyan-500 peer-checked:to-purple-500"></div>
                                    </label>
                                </div>
                                <button id="uploadNewBtn" class="w-full flex items-center justify-center gap-2 p-3 bg-[#1a1a1a] border border-[#333] rounded-lg hover:bg-[#2a2a2a] hover:border-green-400/50 transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="text-green-400" viewBox="0 0 256 256">
                                        <path d="M74.34,85.66A8,8,0,0,1,85.66,74.34L120,108.69V24a8,8,0,0,1,16,0v84.69l34.34-34.35a8,8,0,0,1,11.32,11.32l-48,48a8,8,0,0,1-11.32,0ZM240,136v64a16,16,0,0,1-16,16H32a16,16,0,0,1-16-16V136a16,16,0,0,1,16-16H84.4a4,4,0,0,1,2.83,1.17L111,145a24,24,0,0,0,34,0l23.8-23.8A4,4,0,0,1,171.6,120H224A16,16,0,0,1,240,136Zm-40,32a12,12,0,1,0-12,12A12,12,0,0,0,200,168Z"></path>
                                    </svg>
                                    <span class="text-white text-sm font-medium">Upload New Image</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- API Key Modal -->
    <div id="apiKeyModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center" style="display: none; z-index: 9999;">
        <div class="bg-[#10231c] border border-[#214a3c] rounded-lg p-6 m-4 max-w-md w-full shadow-2xl">
            <h3 class="text-white text-lg font-bold mb-4">API Key Required</h3>
            <p class="text-[#8ecdb7] mb-4">Please enter your Venice AI API key to transform images:</p>
            <input id="apiKeyInput" type="password" placeholder="Enter your API key" value="ntmhtbP2fr_pOQsmuLPuN_nm6lm2INWKiNcvrdEfEC" class="w-full p-3 bg-[#214a3c] text-white rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-[#019863]" />
            <div class="flex gap-2">
                <button id="saveApiKey" class="flex-1 bg-[#019863] text-white px-4 py-2 rounded-lg hover:bg-[#017a50]">Save</button>
                <button id="cancelApiKey" class="flex-1 bg-[#214a3c] text-white px-4 py-2 rounded-lg hover:bg-[#2a5a4a]">Cancel</button>
            </div>
            <div class="mt-2 text-center">
                <button id="usePrefilledKey" class="text-[#8ecdb7] text-sm hover:text-white">Use Pre-filled Key</button>
            </div>
        </div>
    </div>

    <!-- Error Modal -->
    <div id="errorModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center" style="display: none; z-index: 9999;">
        <div class="bg-[#10231c] border border-[#214a3c] rounded-lg p-6 m-4 max-w-md w-full shadow-2xl">
            <h3 class="text-white text-lg font-bold mb-4">Error</h3>
            <p id="errorMessage" class="text-[#8ecdb7] mb-4"></p>
            <button id="closeError" class="w-full bg-[#019863] text-white px-4 py-2 rounded-lg hover:bg-[#017a50]">OK</button>
        </div>
    </div>

    <script>
        class VivMorph {
            constructor() {
                this.originalImage = null;
                this.originalImageFile = null; // Store the original file
                this.transformedImage = null;
                this.currentView = 'original';
                this.currentTab = 'upload';
                this.savedImages = JSON.parse(localStorage.getItem('savedImages') || '[]');
                this.apiKey = localStorage.getItem('veniceApiKey');
                console.log('vivMorph initialized, API key:', this.apiKey ? 'Found' : 'Not found');
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.checkApiKey();
                this.loadSavedImages();
            }

            setupEventListeners() {
                // File upload
                document.getElementById('uploadBtn').addEventListener('click', () => {
                    document.getElementById('fileInput').click();
                });

                document.getElementById('fileInput').addEventListener('change', (e) => {
                    this.handleFileUpload(e);
                });

                // Navigation - mobile and desktop
                document.getElementById('backBtn').addEventListener('click', () => {
                    this.showUploadScreen();
                });

                const backBtnDesktop = document.getElementById('backBtn-desktop');
                if (backBtnDesktop) {
                    backBtnDesktop.addEventListener('click', () => {
                        this.showUploadScreen();
                    });
                }

                // Image toggle
                document.querySelectorAll('input[name="imageToggle"]').forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        this.toggleImage(e.target.value);
                    });
                });

                // Preset buttons
                document.querySelectorAll('.preset-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const prompt = e.currentTarget.dataset.prompt;
                        document.getElementById('promptInput').value = prompt;
                    });
                });

                // Transform button
                document.getElementById('submitBtn').addEventListener('click', () => {
                    this.transformImage();
                });

                // Optimize prompt button
                document.getElementById('optimizeBtn').addEventListener('click', () => {
                    this.optimizePrompt();
                });

                // Download buttons - mobile and desktop
                document.getElementById('downloadBtn').addEventListener('click', () => {
                    this.downloadImage();
                });

                const downloadBtnDesktop = document.getElementById('downloadBtn-desktop');
                if (downloadBtnDesktop) {
                    downloadBtnDesktop.addEventListener('click', () => {
                        this.downloadImage();
                    });
                }

                // API Key modal
                document.getElementById('saveApiKey').addEventListener('click', () => {
                    this.saveApiKey();
                });

                document.getElementById('cancelApiKey').addEventListener('click', () => {
                    this.hideApiKeyModal();
                });

                document.getElementById('usePrefilledKey').addEventListener('click', () => {
                    this.saveApiKey();
                });

                // Error modal
                document.getElementById('closeError').addEventListener('click', () => {
                    this.hideErrorModal();
                });

                // Share buttons - mobile and desktop
                document.getElementById('shareBtn').addEventListener('click', () => {
                    this.shareImage();
                });

                const shareBtnDesktop = document.getElementById('shareBtn-desktop');
                if (shareBtnDesktop) {
                    shareBtnDesktop.addEventListener('click', () => {
                        this.shareImage();
                    });
                }

                // Settings button
                document.getElementById('settingsBtn').addEventListener('click', () => {
                    this.showApiKeyModal();
                });

                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && e.ctrlKey) {
                        this.transformImage();
                    }
                });

                // Tab switching
                document.getElementById('uploadTab').addEventListener('click', () => {
                    this.switchTab('upload');
                });

                document.getElementById('savedTab').addEventListener('click', () => {
                    this.switchTab('saved');
                });

                // Upload new image button
                document.getElementById('uploadNewBtn').addEventListener('click', () => {
                    document.getElementById('fileInput').click();
                });

                // Edit mode toggle
                document.getElementById('editModeToggle').addEventListener('change', (e) => {
                    this.updateEditMode(e.target.checked);
                });

                // Clear saved images
                document.getElementById('clearSavedImages').addEventListener('click', () => {
                    this.clearSavedImages();
                });

                // Compress images
                document.getElementById('compressImages').addEventListener('click', () => {
                    this.compressImages();
                });
            }

            checkApiKey() {
                if (!this.apiKey) {
                    // Show modal after a short delay to ensure DOM is ready
                    setTimeout(() => {
                        this.showApiKeyModal();
                    }, 100);
                }
            }

            showApiKeyModal() {
                console.log('Showing API key modal');
                const modal = document.getElementById('apiKeyModal');
                if (modal) {
                    modal.style.display = 'flex';
                } else {
                    console.error('API key modal not found');
                }
            }

            hideApiKeyModal() {
                document.getElementById('apiKeyModal').style.display = 'none';
            }

            saveApiKey() {
                const key = document.getElementById('apiKeyInput').value.trim();
                if (key) {
                    this.apiKey = key;
                    localStorage.setItem('veniceApiKey', key);
                    console.log('API key saved:', key.substring(0, 10) + '...');
                    this.hideApiKeyModal();
                } else {
                    this.showError('Please enter a valid API key');
                }
            }

            showError(message) {
                document.getElementById('errorMessage').textContent = message;
                document.getElementById('errorModal').style.display = 'flex';
            }

            hideErrorModal() {
                document.getElementById('errorModal').style.display = 'none';
            }

            async handleFileUpload(event) {
                const file = event.target.files[0];
                if (!file) return;

                // Validate file type
                if (!file.type.startsWith('image/')) {
                    this.showError('Please select a valid image file');
                    return;
                }

                // Check file size (10MB limit)
                if (file.size > 10 * 1024 * 1024) {
                    this.showError('Image file is too large. Please select a file smaller than 10MB');
                    return;
                }

                try {
                    // Store the original file for API calls
                    this.originalImageFile = file;
                    
                    // Convert to base64 for display
                    const base64 = await this.fileToBase64(file);
                    this.originalImage = base64;
                    this.transformedImage = null;
                    
                    console.log('Image uploaded:', file.name, file.size, 'bytes');
                    
                    // Show edit screen FIRST
                    this.showEditScreen();
                    this.displayImage();
                    
                    // Try to save original image to local storage (non-blocking)
                    this.saveImageToLocal(base64, 'Original upload', false);
                } catch (error) {
                    this.showError('Error processing image: ' + error.message);
                }
            }

            fileToBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => {
                        // Remove data URL prefix
                        const base64 = reader.result.split(',')[1];
                        resolve(base64);
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            }

            showUploadScreen() {
                document.getElementById('upload-screen').style.display = 'flex';
                document.getElementById('edit-screen').style.display = 'none';
                
                // Clear the file input
                document.getElementById('fileInput').value = '';
            }

            showEditScreen() {
                document.getElementById('upload-screen').style.display = 'none';
                document.getElementById('edit-screen').style.display = 'flex';
            }

            displayImage() {
                const container = document.getElementById('imageContainer');
                const imageToShow = this.currentView === 'original' ? this.originalImage : this.transformedImage;
                const iterationIndicator = document.getElementById('iterationIndicator');
                
                if (imageToShow) {
                    // Handle both base64 strings and full data URLs
                    const imageUrl = imageToShow.startsWith('data:') ? imageToShow : `data:image/jpeg;base64,${imageToShow}`;
                    container.style.backgroundImage = `url(${imageUrl})`;
                    container.innerHTML = '';
                } else if (this.currentView === 'transformed') {
                    container.style.backgroundImage = 'none';
                    container.innerHTML = '<p class="text-gray-400">No transformed image yet</p>';
                } else {
                    container.style.backgroundImage = 'none';
                    container.innerHTML = '<p class="text-gray-400">Upload an image to get started</p>';
                }
                
                // Show iteration indicator if we're viewing transformed image and it exists
                if (iterationIndicator) {
                    if (this.currentView === 'transformed' && this.transformedImage) {
                        iterationIndicator.classList.remove('hidden');
                    } else {
                        iterationIndicator.classList.add('hidden');
                    }
                }
            }

            toggleImage(view) {
                this.currentView = view;
                this.displayImage();
            }

            async transformImage() {
                if (!this.apiKey) {
                    this.showApiKeyModal();
                    return;
                }

                const prompt = document.getElementById('promptInput').value.trim();
                if (!prompt) {
                    this.showError('Please enter a transformation prompt');
                    return;
                }

                if (!this.originalImageFile) {
                    this.showError('Please upload an image first');
                    return;
                }

                const submitBtn = document.getElementById('submitBtn');
                const loadingSpinner = document.getElementById('loadingSpinner');
                
                try {
                    // Show loading state
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<span class="truncate">Transforming...</span>';
                    if (loadingSpinner) {
                        loadingSpinner.classList.remove('hidden');
                    }
                    
                    console.log('Starting transformation...');
                    console.log('API Key:', this.apiKey.substring(0, 10) + '...');
                    console.log('Prompt:', prompt);
                    
                    // Determine which image to use as the base based on edit mode toggle
                    const editModeToggle = document.getElementById('editModeToggle');
                    const useTransformed = editModeToggle.checked && this.transformedImage;
                    const imageToUse = useTransformed ? this.transformedImage : this.originalImageFile;
                    
                    // Create form data
                    const formData = new FormData();
                    formData.append('prompt', prompt);
                    
                    if (imageToUse === this.originalImageFile) {
                        // Use original file
                        formData.append('image', this.originalImageFile);
                        console.log('Using original image file:', this.originalImageFile.name, this.originalImageFile.size, 'bytes');
                    } else {
                        // Convert base64 to blob for API
                        const base64 = this.transformedImage;
                        const blob = await this.base64ToBlob(base64, 'image/png');
                        formData.append('image', blob, 'transformed.png');
                        console.log('Using transformed image as base');
                    }
                    
                    console.log('Sending request to Venice AI...');
                    
                    const response = await fetch('https://api.venice.ai/api/v1/image/edit', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${this.apiKey}`
                            // Don't set Content-Type - let browser set it with boundary for multipart
                        },
                        body: formData
                    });
                    
                    console.log('Response status:', response.status);
                    console.log('Response headers:', Object.fromEntries(response.headers));

                    if (!response.ok) {
                        let errorMessage = `HTTP error! status: ${response.status}`;
                        try {
                            const errorData = await response.json();
                            errorMessage = errorData.message || errorData.error || errorMessage;
                        } catch (e) {
                            // If we can't parse JSON, try to get text
                            try {
                                const errorText = await response.text();
                                if (errorText) {
                                    errorMessage = errorText;
                                }
                            } catch (e2) {
                                // Use default error message
                            }
                        }
                        console.error('API Error:', errorMessage);
                        throw new Error(errorMessage);
                    }

                    // Get the transformed image as blob
                    const blob = await response.blob();
                    const base64 = await this.blobToBase64(blob);
                    
                    this.transformedImage = base64;
                    
                    // Switch to transformed view FIRST (before saving)
                    const transformedRadio = document.querySelector('input[value="transformed"]');
                    if (transformedRadio) {
                        transformedRadio.checked = true;
                    }
                    this.currentView = 'transformed';
                    this.displayImage();
                    
                    // Try to save transformed image to local storage (non-blocking)
                    const currentPrompt = document.getElementById('promptInput').value.trim();
                    this.saveImageToLocal(base64, currentPrompt, true);
                    
                } catch (error) {
                    console.error('Transformation error:', error);
                    this.showError('Failed to transform image: ' + error.message);
                } finally {
                    // Reset loading state
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<span class="truncate">Transform Image</span>';
                    if (loadingSpinner) {
                        loadingSpinner.classList.add('hidden');
                    }
                }
            }

            blobToBase64(blob) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => {
                        const base64 = reader.result.split(',')[1];
                        resolve(base64);
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(blob);
                });
            }

            base64ToBlob(base64, mimeType) {
                const byteCharacters = atob(base64);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                return new Blob([byteArray], { type: mimeType });
            }

            async shareImage() {
                const imageToShare = this.currentView === 'original' ? this.originalImage : this.transformedImage;
                
                if (!imageToShare) {
                    this.showError('No image to share');
                    return;
                }

                try {
                    // Create a download link
                    const link = document.createElement('a');
                    link.href = `data:image/png;base64,${imageToShare}`;
                    link.download = `photo-studio-${this.currentView}-${Date.now()}.png`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                } catch (error) {
                    this.showError('Failed to download image: ' + error.message);
                }
            }

            downloadImage() {
                const imageToDownload = this.currentView === 'original' ? this.originalImage : this.transformedImage;
                
                if (!imageToDownload) {
                    this.showError('No image to download');
                    return;
                }

                try {
                    // Create a download link
                    const link = document.createElement('a');
                    link.href = `data:image/png;base64,${imageToDownload}`;
                    link.download = `photo-studio-${this.currentView}-${Date.now()}.png`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                } catch (error) {
                    this.showError('Failed to download image: ' + error.message);
                }
            }

            async optimizePrompt() {
                const promptInput = document.getElementById('promptInput');
                const userPrompt = promptInput.value.trim();
                
                if (!userPrompt) {
                    this.showError('Please enter a prompt first');
                    return;
                }

                if (!this.apiKey) {
                    this.showApiKeyModal();
                    return;
                }

                const optimizeBtn = document.getElementById('optimizeBtn');
                const originalText = optimizeBtn.textContent;
                
                try {
                    optimizeBtn.textContent = '⏳ Optimizing...';
                    optimizeBtn.disabled = true;

                    const response = await fetch('https://api.venice.ai/api/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${this.apiKey}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            model: "llama-3.3-70b",
                            messages: [
                                {
                                    role: "user",
                                    content: `You are a FLUX.1 image editing prompt optimizer. Your task is to improve the following image transformation prompt to get better results from an AI image editor.

FLUX.1 Kontext Best Practices:
- Be specific and clear with precise language
- Use accurate color names and detailed descriptions
- Directly name subjects (avoid "she", "it", "this")
- Use phrases like "while maintaining the same [facial features/composition/lighting]" to preserve important elements
- Choose precise verbs like "change", "replace", "transform"
- Include explicit composition control when changing backgrounds
- Quote exact text changes when dealing with text in images

Original prompt: "${userPrompt}"

Please optimize this prompt following the guidelines above. Keep the same intent but make it more specific and effective. Return only the improved prompt, nothing else.`
                                }
                            ],
                            temperature: 0.7,
                            max_tokens: 200,
                            stream: false
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    const optimizedPrompt = data.choices[0].message.content.trim();
                    
                    promptInput.value = optimizedPrompt;
                    
                    // Show success feedback
                    optimizeBtn.textContent = '✅ Optimized';
                    setTimeout(() => {
                        optimizeBtn.textContent = originalText;
                        optimizeBtn.disabled = false;
                    }, 1500);
                    
                } catch (error) {
                    console.error('Error optimizing prompt:', error);
                    this.showError('Failed to optimize prompt: ' + error.message);
                    
                    // Reset button state
                    optimizeBtn.textContent = originalText;
                    optimizeBtn.disabled = false;
                }
            }

            // Tab management
            switchTab(tab) {
                this.currentTab = tab;
                const uploadTab = document.getElementById('uploadTab');
                const savedTab = document.getElementById('savedTab');
                const uploadContent = document.getElementById('upload-content');
                const savedContent = document.getElementById('saved-content');

                if (tab === 'upload') {
                    uploadTab.classList.add('bg-gradient-to-r', 'from-cyan-500', 'to-purple-500', 'text-white');
                    uploadTab.classList.remove('text-gray-400');
                    savedTab.classList.remove('bg-gradient-to-r', 'from-cyan-500', 'to-purple-500', 'text-white');
                    savedTab.classList.add('text-gray-400');
                    uploadContent.classList.remove('hidden');
                    savedContent.classList.add('hidden');
                } else {
                    savedTab.classList.add('bg-gradient-to-r', 'from-cyan-500', 'to-purple-500', 'text-white');
                    savedTab.classList.remove('text-gray-400');
                    uploadTab.classList.remove('bg-gradient-to-r', 'from-cyan-500', 'to-purple-500', 'text-white');
                    uploadTab.classList.add('text-gray-400');
                    savedContent.classList.remove('hidden');
                    uploadContent.classList.add('hidden');
                }
            }

            // Edit mode management
            updateEditMode(enabled) {
                const iterationIndicator = document.getElementById('iterationIndicator');
                if (enabled && this.transformedImage) {
                    this.currentView = 'transformed';
                    const transformedRadio = document.querySelector('input[name="imageToggle"][value="transformed"]');
                    if (transformedRadio) {
                        transformedRadio.checked = true;
                    }
                    this.displayImage();
                    if (iterationIndicator) {
                        iterationIndicator.classList.remove('hidden');
                    }
                } else {
                    this.currentView = 'original';
                    const originalRadio = document.querySelector('input[name="imageToggle"][value="original"]');
                    if (originalRadio) {
                        originalRadio.checked = true;
                    }
                    this.displayImage();
                    if (iterationIndicator) {
                        iterationIndicator.classList.add('hidden');
                    }
                }
            }

            // Save image to local storage (with error handling)
            saveImageToLocal(imageData, prompt, isTransformed = false) {
                try {
                    // Check if we're close to storage limit (rough estimate)
                    const currentStorage = JSON.stringify(this.savedImages).length;
                    const estimatedNewSize = imageData.length + 200; // rough overhead
                    
                    if (currentStorage + estimatedNewSize > 4000000) { // 4MB safety limit
                        console.warn('Storage nearly full, skipping save to prevent quota exceeded');
                        this.showStorageWarning();
                        return;
                    }

                    const imageInfo = {
                        id: Date.now(),
                        data: imageData,
                        prompt: prompt || 'No prompt',
                        timestamp: new Date().toISOString(),
                        isTransformed: isTransformed
                    };
                    
                    this.savedImages.push(imageInfo);
                    localStorage.setItem('savedImages', JSON.stringify(this.savedImages));
                    this.loadSavedImages();
                    console.log('Image saved successfully');
                } catch (error) {
                    console.warn('Failed to save image to localStorage:', error.message);
                    if (error.name === 'QuotaExceededError') {
                        this.showStorageWarning();
                    }
                }
            }

            // Show storage warning
            showStorageWarning() {
                // Create a temporary notification
                const notification = document.createElement('div');
                notification.className = 'fixed top-4 right-4 bg-yellow-500/20 border border-yellow-500/50 text-yellow-300 px-4 py-3 rounded-lg z-50 max-w-sm';
                notification.innerHTML = `
                    <div class="flex items-start gap-3">
                        <span class="text-xl">⚠️</span>
                        <div>
                            <h4 class="font-semibold mb-1">Storage Almost Full</h4>
                            <p class="text-xs">Clear some saved images to continue saving new ones.</p>
                        </div>
                    </div>
                `;
                document.body.appendChild(notification);
                
                // Auto remove after 5 seconds
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 5000);
            }

            // Load and display saved images
            loadSavedImages() {
                const grid = document.getElementById('savedImagesGrid');
                const noSavedImages = document.getElementById('noSavedImages');
                const storageInfo = document.getElementById('storageInfo');
                
                // Update storage info
                if (storageInfo) {
                    const storageSize = JSON.stringify(this.savedImages).length;
                    const storageMB = (storageSize / 1024 / 1024).toFixed(2);
                    const storagePercent = Math.min((storageSize / 5000000) * 100, 100).toFixed(1); // Assume 5MB limit
                    storageInfo.innerHTML = `${this.savedImages.length} images • ${storageMB}MB used • ${storagePercent}% of storage`;
                }
                
                if (this.savedImages.length === 0) {
                    noSavedImages.classList.remove('hidden');
                    grid.innerHTML = '';
                    return;
                }
                
                noSavedImages.classList.add('hidden');
                
                grid.innerHTML = this.savedImages.map(img => `
                    <div class="bg-[#1a1a1a] border border-[#333] rounded-lg overflow-hidden hover:border-cyan-400/50 transition-colors">
                        <div class="aspect-square bg-center bg-cover bg-no-repeat" style="background-image: url(data:image/png;base64,${img.data})"></div>
                        <div class="p-4">
                            <p class="text-white text-sm font-medium mb-1">${img.isTransformed ? '🎨 Transformed' : '📷 Original'}</p>
                            <p class="text-gray-400 text-xs mb-2 line-clamp-2">${img.prompt}</p>
                            <p class="text-gray-500 text-xs">${new Date(img.timestamp).toLocaleDateString()}</p>
                            <div class="flex gap-2 mt-3">
                                <button onclick="vivMorph.downloadSavedImage('${img.id}')" class="flex-1 bg-cyan-500/20 text-cyan-400 px-3 py-1 rounded text-xs hover:bg-cyan-500/30 transition-colors">
                                    Download
                                </button>
                                <button onclick="vivMorph.deleteSavedImage('${img.id}')" class="bg-red-500/20 text-red-400 px-3 py-1 rounded text-xs hover:bg-red-500/30 transition-colors">
                                    Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            // Download saved image
            downloadSavedImage(id) {
                const image = this.savedImages.find(img => img.id == id);
                if (image) {
                    const link = document.createElement('a');
                    link.href = `data:image/png;base64,${image.data}`;
                    link.download = `saved-image-${id}.png`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            }

            // Delete saved image
            deleteSavedImage(id) {
                this.savedImages = this.savedImages.filter(img => img.id != id);
                localStorage.setItem('savedImages', JSON.stringify(this.savedImages));
                this.loadSavedImages();
            }

            // Clear all saved images
            clearSavedImages() {
                if (confirm('Are you sure you want to delete all saved images? This cannot be undone.')) {
                    this.savedImages = [];
                    localStorage.setItem('savedImages', JSON.stringify(this.savedImages));
                    this.loadSavedImages();
                }
            }

            // Compress saved images to save storage space
            async compressImages() {
                if (this.savedImages.length === 0) {
                    alert('No images to compress');
                    return;
                }

                if (!confirm(`Compress ${this.savedImages.length} images to save storage space? This will reduce image quality but free up space.`)) {
                    return;
                }

                const compressBtn = document.getElementById('compressImages');
                const originalText = compressBtn.textContent;
                compressBtn.textContent = '🗜️ Compressing...';
                compressBtn.disabled = true;

                try {
                    const compressedImages = [];
                    
                    for (let i = 0; i < this.savedImages.length; i++) {
                        const img = this.savedImages[i];
                        try {
                            // Create a canvas to compress the image
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            const image = new Image();
                            
                            await new Promise((resolve, reject) => {
                                image.onload = resolve;
                                image.onerror = reject;
                                image.src = `data:image/png;base64,${img.data}`;
                            });

                            // Reduce size by 50% and quality
                            canvas.width = Math.max(image.width * 0.5, 400);
                            canvas.height = Math.max(image.height * 0.5, 400);
                            
                            ctx.drawImage(image, 0, 0, canvas.width, canvas.height);
                            
                            // Convert to JPEG with lower quality
                            const compressedData = canvas.toDataURL('image/jpeg', 0.6).split(',')[1];
                            
                            compressedImages.push({
                                ...img,
                                data: compressedData
                            });
                        } catch (error) {
                            console.warn('Failed to compress image:', error);
                            // Keep original if compression fails
                            compressedImages.push(img);
                        }
                    }
                    
                    this.savedImages = compressedImages;
                    localStorage.setItem('savedImages', JSON.stringify(this.savedImages));
                    this.loadSavedImages();
                    
                    // Show success notification
                    const notification = document.createElement('div');
                    notification.className = 'fixed top-4 right-4 bg-green-500/20 border border-green-500/50 text-green-300 px-4 py-3 rounded-lg z-50';
                    notification.innerHTML = `
                        <div class="flex items-center gap-2">
                            <span>✅</span>
                            <span>Images compressed successfully!</span>
                        </div>
                    `;
                    document.body.appendChild(notification);
                    
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 3000);
                    
                } catch (error) {
                    console.error('Error compressing images:', error);
                    alert('Failed to compress images. Please try again.');
                } finally {
                    compressBtn.textContent = originalText;
                    compressBtn.disabled = false;
                }
            }
        }

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, initializing vivMorph...');
            window.vivMorph = new VivMorph();
        });
    </script>
</body>
</html>